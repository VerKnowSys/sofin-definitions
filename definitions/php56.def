APP_FULL_NAME="PHP"
APP_SHA="077c99b67fb427360796824a581e954b1623b0de"
APP_NAME="php"
APP_VERSION="5.6.17"
APP_POSTFIX="56"
APP_HTTP_PATH="${MAIN_SOURCE_REPOSITORY}${APP_NAME}-${APP_VERSION}.tar.xz"
APP_CONFIGURE_ARGS="--disable-all --with-libdir=${PREFIX}/lib --with-layout=PHP --with-libxml-dir=${PREFIX} --with-pcre-dir=${PREFIX} --with-zlib-dir=${PREFIX} --with-gettext=${PREFIX} --with-gd --with-png-dir=${PREFIX} --with-jpeg-dir=${PREFIX} --enable-exif --enable-zip --enable-mysqlnd --without-apache --disable-debug --enable-fpm --enable-sockets --enable-soap --enable-json --enable-xml --enable-libxml --enable-dom --enable-cli --enable-session --enable-hash --enable-simplexml --enable-filter --enable-pdo --with-pdo-mysql=${PREFIX} --with-pdo-pgsql=${PREFIX} --enable-mbstring --enable-fileinfo --with-openssl --enable-intl --with-mcrypt=${PREFIX} --with-mysql=mysqlnd --with-mysqli=mysqlnd --with-openssl-dir=${PREFIX} --with-pgsql=${PREFIX} --with-curl=${PREFIX} --with-gmp=${PREFIX} --with-freetype-dir=${PREFIX} --with-pear --with-xsl=${PREFIX} --enable-posix --with-bz2 --enable-ftp --enable-calendar --enable-bcmath --enable-wddx --enable-zip --enable-intl --with-mssql=${PREFIX} --with-xmlrpc --with-kerberos --with-iconv --disable-maintainer-zts --enable-cgi --disable-roxen-zts --enable-ctype --with-mhash=${PREFIX} --enable-tokenizer --enable-xmlwriter --enable-xmlreader --enable-sqlite-utf8 --with-sqlite=${PREFIX} --with-pdo-sqlite=${PREFIX} --with-sqlite3=${PREFIX} --with-ldap=${PREFIX} --with-ldap-sasl=${PREFIX} --with-imap-ssl=${PREFIX} --with-imap=${PREFIX} --with-litespeed --enable-fastcgi --enable-cgi --enable-opcache --enable-phar"
APP_REQUIREMENTS="gmake perl libiconv pkgconf zlib nasm lzma lzo db libpng jpeg libressl cclient gettext bzip2 m4 gmp51 autoconf bison27 flex readline postgresql94 python27 libxml2 libtool icu libgpg-error libgcrypt libxslt pcre libexif freetype fontconfig tiff jasper jbig2dec jbigkit libjpeg-turbo gd cmake ncurses mysql libmcrypt texinfo libidn curl imagemagick freetds sqlite2 sqlite cyrus-sasl openldap geoip libnet krb re2c"
APP_INSTALL_METHOD="gmake install -s"
APP_EXPORTS="php php-cgi php-fpm php-config phpize pecl pear lsphp"
APP_USELESS="doc docs lib/perl* mysql-test scripts sql-bench support-files data Software man bin/DB lib/libperl.so share/*.sql share/man share/gtk-doc share/cmake* share/aclocal lib/python* include/python*"

case "${SYSTEM_NAME}" in
    Linux)
        export APP_CONFIGURE_ARGS="${APP_CONFIGURE_ARGS} --with-config-file-path=${PREFIX}"
        ;;

    FreeBSD)
        export APP_CONFIGURE_ARGS="${APP_CONFIGURE_ARGS} --with-config-file-path=${SERVICE_DIR}/etc"
        ;;
esac


hack_after_unpack () {
    # HACK: Required to detect freetds (don't blame me, but Php/TDS guys for messed up library detection)
    ${MKDIR_BIN} -p ${PREFIX}/Software
    ${LN_BIN} -s ${PREFIX} ${PREFIX}/Software || true
}
APP_AFTER_UNPACK_CALLBACK="hack_after_unpack"
APP_AFTER_CONFIGURE_CALLBACK="${RM_BIN} -rf ${PREFIX}/Software || true"

# install extensions
APP_AFTER_INSTALL_CALLBACK="install_extensions"
#APP_CLEAN_USELESS="false"


install_geoip () {
    PATH=$PATH:${PREFIX}/bin:/bin echo ${PREFIX} | ${PREFIX}/bin/pecl install geoip
    test "$?" = "0" || error "Error building geoip"
}

install_imagick () {
    PATH=$PATH:${PREFIX}/bin echo ${PREFIX} | ${PREFIX}/bin/pecl install imagick
    test "$?" = "0" || error "Error building imagick"
}

install_rar () {
    PATH=$PATH:${PREFIX}/bin echo ${PREFIX} | ${PREFIX}/bin/pecl install rar
    test "$?" = "0" || error "Error building rar"
}

install_phalcon () {
    ${GIT_BIN} clone --depth=1 git://github.com/phalcon/cphalcon.git
    cd cphalcon/build
    PATH=${PREFIX}/bin:$PATH ./install
    test "$?" = "0" || error "Error building cphalcon"
}

install_pear_modules () {
    for mod in Archive_Tar Auth Auth_HTTP Auth_SASL Benchmark Cache Cache_Lite Config Date DB DB_DataObject DB_DataObject_FormBuilder File HTML_Common HTML_Form HTML_QuickForm HTML_QuickForm_Controller HTML_Table HTML_Template_Flexy HTML_Template_IT HTML_Template_Sigma HTML_TreeMenu HTTP HTTP_Client HTTP_Download HTTP_Header HTTP_Request HTTP_Upload Image_Canvas Image_Color Image_Graph Log Mail Mail_Mime Mail_mimeDecode MDB MDB2 MDB2_Driver_mysql MIME_Type Net_DNS Net_FTP Net_IMAP Net_IPv4 Net_IPv6 Net_Ping Net_POP3 Net_SMTP Net_Socket Net_URL2 Net_URL Net_UserAgent_Detect Numbers_Roman Numbers_Words OLE Pager PHP_Compat PhpDocumentor PHPUnit Services_Weather SOAP Spreadsheet_Excel_Writer Structures_Graph Text_Password Validate XML_Beautifier XML_Parser XML_RPC XML_Serializer XML_Tree XML_Util mdb OLE-beta Spreadsheet_Excel_Writer-beta Crypt_CHAP Numbers_Words-beta File_Passwd HTTP_WebDAV_Server xml_rpc2;
    do
        ${PREFIX}/bin/pear install $mod
    done
}

install_dbase () {
    PATH=${PREFIX}/bin:$PATH ${PREFIX}/bin/pecl install dbase
}

install_extensions () {
    # update pecl protocols before installing extensions
    PATH=${PREFIX}/bin:$PATH ${PREFIX}/bin/pecl channel-update pecl.php.net

    install_imagick
    install_rar
    if [ "${SYSTEM_NAME}" = "Linux" ]; then
        install_geoip
        # install_phalcon
    fi
    install_dbase
    install_pear_modules
    ${CP_BIN} -v ${PREFIX}/lib/php/extensions/no-debug*/* ${PREFIX}/lib/php/extensions
}
