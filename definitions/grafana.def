APP_FULL_NAME="Grafana"
APP_NAME="grafana"
APP_VERSION="2.6.0"
APP_HTTP_PATH="git://github.com/OliverLetterer/dummy-repo.git"
APP_GIT_MODE="true"
APP_GIT_CHECKOUT="master"
APP_REQUIREMENTS="pkgconf pcre go zlib bzip2 gmake yaml libiconv python27 node42"
APP_CONFIGURE_SCRIPT="ignore"
APP_MAKE_METHOD="make_action"
APP_INSTALL_METHOD="install_links"
APP_USELESS="doc test include share src local/src misc pkg api"
APP_EXPORTS="grafana"
APP_NO_CCACHE="true"

make_action () {
    debug "Fetching Grafana"
    # XXX: hardcoded path to git:
    export PATH=${PATH}:/Software/Git/exports && \
    export GOPATH=${PREFIX} && \
    ${PREFIX}/bin/go get github.com/grafana/grafana && \
    cd ${PREFIX}/local/src/github.com/grafana/grafana && \
    debug "Fetching dependencies of Grafana" && \
    ${PREFIX}/bin/go run build.go setup && \
    ${PREFIX}/local/bin/godep restore && \
    debug "Building Grafana" && \
    ${PREFIX}/bin/go build . && \
    debug "Installing Grafana" && \
    ${PREFIX}/bin/go install . && \
    debug "Installing node modules" && \
    cd ${PREFIX} && \
    ${GIT_BIN} clone https://github.com/grafana/grafana.git grafana-github && \
    cd grafana-github && \
    ${GIT_BIN} checkout -b "v${APP_VERSION}" && \
    ${PREFIX}/bin/npm install && \
    ${PREFIX}/bin/npm install -g grunt-cli && \
    ${PREFIX}/bin/grunt && \
    ${CP_BIN} -R public/ ../public && \
    ${CP_BIN} -R conf/ ../conf && \
    cd .. && \
    ${RM_BIN} -rf ./grafana-github && \
    debug "Done."
}

install_links () {
    for binary in godep grafana; do
        ${LN_BIN} -s ${PREFIX}/local/bin/${binary} ${PREFIX}/bin/${binary}
    done
}
