DEF_FULL_NAME="Lua"
DEF_SHA="b3882111ad02ecc6b972f8c1241647905cb2e3fc"
DEF_NAME="lua"
DEF_VERSION="5.1.5"
DEF_SUFFIX="51"
DEF_SOURCE_PATH="${MAIN_SOURCE_REPOSITORY}${DEF_NAME}-${DEF_VERSION}.tar.gz"
DEF_REQUIREMENTS="libedit"
DEF_EXPORTS="lua luac"
DEF_CONFIGURE_METHOD="ignore"
unset DEF_USE_LTO
case "${SYSTEM_NAME}" in
    Linux)
        DEF_MAKE_METHOD="make linux"
        ;;

    FreeBSD)
        DEF_MAKE_METHOD="make freebsd"
        ;;

    Darwin)
        DEF_MAKE_METHOD="make macosx"
        ;;

    *)
        DEF_MAKE_METHOD="make posix"
        ;;
esac

DEF_AFTER_CONFIGURE_METHOD="patch_makefile"
patch_makefile () {
    # if [ "${SYSTEM_NAME}" != "Darwin" ]; then
    #     _addon="-Wl,-rpath=${PREFIX}/lib,--enable-new-dtags -Wl,-fuse-ld=gold"
    # fi
    ${SED_BIN} -i '' -e "s#readline/readline.h#editline/readline.h#g" src/luaconf.h
    ${SED_BIN} -i '' -e "s#= /usr/local#= ${PREFIX}#" Makefile
    ${SED_BIN} -i '' -e "s#CFLAGS= .*\$#CFLAGS= ${CFLAGS} -I${PREFIX}/include -I/usr/include/edit/ \$(MYCFLAGS)#;s#-lreadline#-ledit#g;" src/Makefile
    ${SED_BIN} -i '' -e "s#LIBS= -lm#LIBS= ${LDFLAGS} -L${PREFIX}/lib -lm#" src/Makefile
    # unset _addon

    if [ "${SYSTEM_NAME}" != "Linux" ]; then
        ${SED_BIN} -i '' -e "s/CC= gcc/CC= clang/" src/Makefile
    fi
}

# because Lua guys possibly don't know how to do things correctly:
DEF_AFTER_MAKE_METHOD="create_pc"
create_pc () {
    ${MKDIR_BIN} -p ${PREFIX}/lib/pkgconfig
    ${SED_BIN} -i '' -e "s#/usr/local#${PREFIX}#" etc/lua.pc
    ${INSTALL_BIN} -v etc/lua.pc ${PREFIX}/lib/pkgconfig/
}
DEF_INSTALL_METHOD="make -s install"
