DEF_FULL_NAME="Lua"
DEF_SHA="b3882111ad02ecc6b972f8c1241647905cb2e3fc"
DEF_NAME="lua"
DEF_VERSION="5.1.5"
DEF_POSTFIX="51"
DEF_HTTP_PATH="${MAIN_SOURCE_REPOSITORY}${APP_NAME}-${APP_VERSION}.tar.gz"
DEF_EXPORTS="lua luac"
DEF_CONFIGURE="ignore"
case "${SYSTEM_NAME}" in
    Linux)
        DEF_MAKE_METHOD="make linux"
        ;;

    FreeBSD)
        DEF_MAKE_METHOD="make freebsd"
        ;;

    Darwin)
        DEF_MAKE_METHOD="make macosx"
        ;;

    *)
        DEF_MAKE_METHOD="make posix"
        ;;
esac

DEF_AFTER_CONFIGURE_CALLBACK="patch_makefile"
patch_makefile () {
    ${SED_BIN} -i '' -e "s#= /usr/local#= ${PREFIX}#" Makefile || true # Linux..
    ${SED_BIN} -i '' -e "s#CFLAGS= .*\$#CFLAGS= -O2 -Wall -mno-avx -fPIC -I${PREFIX}/include \$(MYCFLAGS)#" src/Makefile || true # Linux..
    ${SED_BIN} -i '' -e "s#LIBS= -lm#LIBS= -L${PREFIX}/lib -lm -lncursesw #" src/Makefile || true # Linux..
    if [ "${SYSTEM_NAME}" != "Linux" ]; then
        ${SED_BIN} -i '' -e "s/CC= gcc/CC= clang/" src/Makefile
    fi
}

# because Lua guys possibly don't know how to do things correctly:
DEF_AFTER_MAKE_CALLBACK="create_pc"
create_pc () {
    ${MKDIR_BIN} -p ${PREFIX}/lib/pkgconfig
    ${SED_BIN} -i '' -e "s#/usr/local#${PREFIX}#" etc/lua.pc
    ${INSTALL_BIN} -v etc/lua.pc ${PREFIX}/lib/pkgconfig/
}
DEF_INSTALL_METHOD="make -s install"
