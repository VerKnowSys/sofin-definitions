DEF_REQUIRE_ROOT_ACCESS=YES
DEF_STANDALONE=YES
DEF_DEF_DISABLE_ON="Linux Darwin"
DEF_FULL_NAME="Courier Mail Server"
DEF_SHA="6e6f279530bcca09090cd9f6a47003a7421ba3ef"
DEF_NAME="courier"
DEF_VERSION="0.75.0"
DEF_SOURCE_PATH="${MAIN_SOURCE_REPOSITORY}${DEF_NAME}-${DEF_VERSION}.tar.bz2"
DEF_REQUIREMENTS="pkgconf-static make-static perl pcre m4 libtool openssl db expat gettext courier-unicode courier-authlib courier-imap"
DEF_LINKER_FLAGS="-lpthread"
DEF_CONFIGURE_ARGS="--enable-mimetypes=/etc/mime.types --disable-silent-rules --disable-root-check --enable-syslog=1 --enable-use-flock --enable-unicode --enable-workarounds-for-imap-client-bugs --enable-mimecharset=UTF-8 --without-ipv6 --without-ispell --with-db=db --disable-static" # NOTE: this mime.types file exists in ServeD system by default, same with /etc/ssl
DEF_EXPORTS="addcr courier-config courierauthconfig couriermlm couriertls deliverquota mailbot maildiracl maildirkw maildirmake maildrop makemime pop3d aliaslookup courier esmtpd imapd-ssl makepercentrelay mkesmtpdcert pop3login showmodules webmaild authdaemond courieresmtpd esmtpd-msa imaplogin makesmtpaccess mkimapdcert pw2userdb userdb authenumerate courierfilter esmtpd-ssl makeacceptmailfor makesmtpaccess-msa mkpop3dcert sharedindexinstall userdb-test-cram-md5 authpasswd courierlogger filterctl makealiases makeuserdb sharedindexsplit userdbpw authtest couriertcpd imapd makehosteddomains makeuucpneighbors pop3d-ssl showconfig webgpg courier-admin mailq recode-sr-latin sendmail testmxlookup webmlmd webmlmd.rc rmail reformime reformail makedat dotforward cancelmsg"
DEF_AFTER_UNPACK_METHOD="umask 022 && mkdir -p ${SERVICE_DIR}/var"
DEF_AFTER_CONFIGURE_METHOD="umask 022 && fix_fail_in_esmtpd_makefile ; umask 022 && fix_fail_in_makefile"
DEF_AFTER_INSTALL_METHOD="umask 022 && create_authfile ; install_courier_admin"
DEF_MAKE_METHOD="umask 022 && make ${MAKE_OPTS}"
DEF_INSTALL_METHOD="umask 022 && make install ${MAKE_OPTS} && make install-configure"

fix_fail_in_esmtpd_makefile () {
    ${SED_BIN} -i '' -e 's#cp $< $@#cp esmtpd.cnf.openssl $@#' courier/module.esmtp/Makefile
}

fix_fail_in_makefile () {
    ${SED_BIN} -i '' -e 's/publish-https.*$/true/' Makefile
}


create_authfile () {
  printf "
authmodulelist=\"authuserdb\"
authmodulelistorig=\"authuserdb authcustom authpipe\"
DEBUG_LOGIN=0
daemons=5
authdaemonvar=${SERVICE_DIR}/var/spool/authdaemon
DEFAULTOPTIONS=\"\"
LOGGEROPTS=\"\"
" > "${SERVICE_DIR}/etc/authlib/authdaemonrc"
}

install_courier_admin () {
  ${FETCH_BIN} -o - \
    "https://raw.githubusercontent.com/VerKnowSys/courier-admin/master/courier-admin" \
    > "courier-admin"
  ${INSTALL_BIN} -v \
    "courier-admin" \
    "${PREFIX}/bin/courier-admin"
}
DEF_USEFUL="bin/perl*"
DEF_USELESS="lib/perl* lib/pkgconfig lib/courier-authlib/*.a docs share/htmldoc share/info share/libtool share/gettext*"
unset DEF_USE_LTO
