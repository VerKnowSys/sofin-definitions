REQUIRE_ROOT_ACCESS="true"
APP_STANDALONE="true"
APP_DISABLE_ON="Linux Darwin"
DATA_DIR="/SystemUsers/SoftwareData/Courier/"
APP_FULL_NAME="Courier Mail Server"
APP_SHA="6e6f279530bcca09090cd9f6a47003a7421ba3ef"
APP_NAME="courier"
APP_VERSION="0.75.0"
APP_HTTP_PATH="${MAIN_SOURCE_REPOSITORY}${APP_NAME}-${APP_VERSION}.tar.bz2"
APP_REQUIREMENTS="pkgconf libiconv perl pcre m4 libtool openssl db gmake expat gettext courier-unicode courier-authlib courier-imap"
APP_LINKER_ARGS="-lpthread"
APP_CONFIGURE_ARGS="--enable-mimetypes=/etc/mime.types --disable-silent-rules --disable-root-check --enable-syslog=1 --enable-use-flock --enable-unicode --enable-workarounds-for-imap-client-bugs --enable-mimecharset=UTF-8 --without-ipv6 --without-ispell --with-db=db --cache-file=${PREFIX}courier.cache --sysconfdir=${DATA_DIR}etc --localstatedir=${DATA_DIR}var --with-certsdir=/etc/ssl --with-etcdir=${DATA_DIR}etc --disable-static" # NOTE: this mime.types file exists in ServeD system by default, same with /etc/ssl
APP_INSTALL_METHOD="gmake install && gmake install-configure"
APP_EXPORTS="addcr courier-config courierauthconfig couriermlm couriertls deliverquota mailbot maildiracl maildirkw maildirmake maildrop makemime pop3d aliaslookup courier esmtpd imapd-ssl makepercentrelay mkesmtpdcert pop3login showmodules webmaild authdaemond courieresmtpd esmtpd-msa imaplogin makesmtpaccess mkimapdcert pw2userdb userdb authenumerate courierfilter esmtpd-ssl makeacceptmailfor makesmtpaccess-msa mkpop3dcert sharedindexinstall userdb-test-cram-md5 authpasswd courierlogger filterctl makealiases makeuserdb sharedindexsplit userdbpw authtest couriertcpd imapd makehosteddomains makeuucpneighbors pop3d-ssl showconfig webgpg courier-admin mailq recode-sr-latin sendmail testmxlookup webmlmd webmlmd.rc rmail reformime reformail makedat dotforward cancelmsg"
APP_AFTER_UNPACK_CALLBACK="mkdir -p ${DATA_DIR}"
APP_AFTER_CONFIGURE_CALLBACK="fix_fail_in_esmtpd_makefile ; fix_fail_in_makefile"
APP_AFTER_INSTALL_CALLBACK="create_authfile ; install_courier_admin"
APP_MAKE_METHOD="gmake -s ${MAKE_OPTS}"
APP_INSTALL_METHOD="gmake install -s ${MAKE_OPTS}"

fix_fail_in_esmtpd_makefile () {
    ${SED_BIN} -i '' -e 's#cp $< $@#cp esmtpd.cnf.openssl $@#' courier/module.esmtp/Makefile
}

fix_fail_in_makefile () {
    ${SED_BIN} -i '' -e 's/publish-https.*$/true/' Makefile
}


create_authfile () {
  ${PRINTF_BIN} "
authmodulelist=\"authuserdb\"
authmodulelistorig=\"authuserdb authcustom authpipe\"
DEBUG_LOGIN=0
daemons=5
authdaemonvar=${DATA_DIR}var/spool/authdaemon
DEFAULTOPTIONS=\"\"
LOGGEROPTS=\"\"
" > "${DATA_DIR}etc/authlib/authdaemonrc"
}

install_courier_admin () {
  ${CURL_BIN} "https://raw.github.com/VerKnowSys/courier-admin/master/courier-admin" > "${PREFIX}/bin/courier-admin" && \
  ${CHMOD_BIN} 755 "${PREFIX}/bin/courier-admin"
}
