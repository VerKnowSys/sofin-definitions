DISABLED_ON="Darwin Linux"
DEF_FULL_NAME="Grub2 for BHYVE"
DEF_NAME="grub2-bhyve"
DEF_VERSION="0.40"
DEF_GIT_CHECKOUT="v${DEF_VERSION}"
DEF_SOURCE_PATH="https://github.com/grehan-freebsd/${DEF_NAME}.git"
DEF_CONFIGURE_ARGS="CC=${PREFIX}/bin/gcc LEX=${PREFIX}/bin/flex --with-platform=emu --enable-grub-mount=no --enable-grub-mkfont=no --enable-grub-emu-sdl=no --disable-nls --disable-werror --with-bootdir=${SERVICE_DIR}/boot --with-grubdir=${SERVICE_DIR}/boot/grub --with-gnu-ld"
DEF_REQUIREMENTS="make-static m4 perl bison flex libressl python27 gmp mpfr libmpc expat gettext zip isl012 autoconf libtool automake binutils-gold gcc"
DEF_USELESS="include/python* lib/*perl* lib/*python* lib/gcc lib/gettext lib/include libexec sbin share/gettext* share/libtool share/bison x86_64-unknown-freebsd* include lib/*.la lib/*.py share/man/man3 share/auto* share/aclocal*"
DEF_EXPORTS="grub-bhyve grub-editenv grub-emu grub-emu-lite grub-fstest grub-kbdcomp grub-menulst2cfg grub-mkimage grub-mklayout grub-mkpasswd-pbkdf2 grub-mkrelpath grub-mkstandalone grub-script-check"
DEF_AFTER_UNPACK_METHOD="prepare_lazily"
prepare_lazily () {
    # Gcc panics when trying to pass -fPIC to build, but we can't set it globally
    # because by design it will also affect all dependencies
    # and cause failure on link
    CROSS_PLATFORM_COMPILER_FLAGS="-w -O2 -fno-strict-overflow -fno-stack-protector"
    DEFAULT_COMPILER_FLAGS="${CROSS_PLATFORM_COMPILER_FLAGS} -Wl,-fuse-ld=gold"
    CXXFLAGS="-I${PREFIX}/include ${CROSS_PLATFORM_COMPILER_FLAGS} -Wl,-rpath=${PREFIX}/lib,--enable-new-dtags"
    CFLAGS="${CXXFLAGS}"
    LDFLAGS="-L${PREFIX}/lib -lssp -lintl -Wl,-fuse-ld=gold -Wl,-rpath=${PREFIX}/lib,--enable-new-dtags -fno-stack-protector"
}
DEF_MAKE_METHOD="make -s"
DEF_INSTALL_METHOD="make -s install"
DEF_AFTER_INSTALL_METHOD="make_link_and_service_dirs"
make_link_and_service_dirs () {
    ${LN_BIN} -s ${PREFIX}/bin/grub-emu ${PREFIX}/bin/grub-bhyve
    ${MKDIR_BIN} -p ${SERVICE_DIR}/boot/grub ${PREFIX}/sbin
}
