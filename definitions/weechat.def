DEF_FULL_NAME="WeeChat, the extensible chat client"
DEF_STANDALONE=YES
DEF_NAME="weechat"
DEF_VERSION="2.8"
DEF_SHA="fec7018168f2fa973b1a4d8224fdac8b59617ada"
DEF_SOURCE_PATH="${MAIN_SOURCE_REPOSITORY}${DEF_NAME}-${DEF_VERSION}.tar.xz"
DEF_ORIGIN="https://weechat.org/files/src/${DEF_NAME}-${DEF_VERSION}.tar.xz" # https://github.com/weechat/weechat/releases
DEF_CONFIGURE_METHOD="cmake"
DEF_EXPORTS="weechat weechat-curses"
DEF_USELESS="lib/*a include share/aclocal"
DEF_USEFUL="bin/pip* bin/python* bin/ruby* bin/gem* bin/perl* bin/cpan*"

DEF_CONFIGURE_ARGS="-DENABLE_PHP=OFF -DENABLE_TCL=OFF -DENABLE_GUILE=OFF -DENABLE_RELAY=OFF -DENABLE_XFER=OFF -DENABLE_JAVASCRIPT=OFF -DENABLE_HEADLESS=OFF -DENABLE_NLS=OFF -DCA_FILE=${SERVICE_DIR}/etc/ssl/cert.pem -DENABLE_NCURSES=ON -DENABLE_GNUTLS=ON -DENABLE_PERL=ON -DENABLE_NCURSES=ON -DENABLE_GNUTLS=ON -DENABLE_PYTHON=ON -DENABLE_LUA=ON -DENABLE_SPELL=ON"
case "${SYSTEM_NAME}" in
    Darwin)
        DEF_REQUIREMENTS="jemalloc libunistring zlib lzo libedit lua51 pcre libffi openssl libgpg-error libgcrypt gmp nettle libtasn1 p11-kit texinfo libidn gnutls libidn2 nghttp2 libssh2 libuuid curl ruby24"
        DEF_CONFIGURE_ARGS="${DEF_CONFIGURE_ARGS} -DENABLE_RUBY=ON"
        ;;

    *)
        # TODO: figure out magic with ruby25 build options that cause troubles here..
        DEF_REQUIREMENTS="libffi libressl expat readline gettext libtool aspell-lib gmp python37 jemalloc libunistring lzo libedit lua51 libevent pcre perl libgpg-error libgcrypt nettle libtasn1 p11-kit texinfo libidn gnutls libidn2 nghttp2 libssh2 libuuid curl"
        DEF_AFTER_MAKE_METHOD="install_dictionaries; install_additional_requirements; remove_services_bin"
        DEF_CONFIGURE_ARGS="${DEF_CONFIGURE_ARGS} -DENABLE_RUBY=OFF"
        install_additional_requirements () {
            # Install wee_slack.py requirements:
            try "${PREFIX}/bin/pip3 install --upgrade pip"
            try "${PREFIX}/bin/pip3 install pync"
            try "${PREFIX}/bin/pip3 install websocket-client"
        }

        install_dictionaries () {
            try "fetch ${MAIN_SOURCE_REPOSITORY}sjp-aspell6-pl-6.0_20200220-0.tar.bz2"
            try "tar xf sjp-aspell6-pl-6.0_20200220-0.tar.bz2"
            try "cd aspell6-pl-6.0_20200220-0 && ./configure && make && make install"

            try "fetch ${MAIN_SOURCE_REPOSITORY}aspell6-en-2019.10.06-0.tar.bz2"
            try "tar xf aspell6-en-2019.10.06-0.tar.bz2"
            try "cd aspell6-en-2019.10.06-0 && ./configure && make && make install"
        }

        remove_services_bin () {
            try "${RM_BIN} -rf ${SERVICE_DIR}/bin"
        }
        ;;
esac

DEF_USE_SAFE_STACK=YES

case "${SYSTEM_NAME}-${SYSTEM_VERSION}" in
    FreeBSD-11*)
        unset DEF_USE_LTO
        ;;
esac
