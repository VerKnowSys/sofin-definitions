DEF_FULL_NAME="Nginx Standalone"
DEF_STANDALONE=YES
DEF_NAME="nginx"
DEF_SHA="150bfcdb620de41342ae574d6869c937566dc98c"
DEF_ORIGIN="http://nginx.org/download/"
DEF_VERSION="1.15.0"
DEF_SOURCE_PATH="${MAIN_SOURCE_REPOSITORY}${DEF_NAME}-${DEF_VERSION}.tar.gz"
DEF_REQUIREMENTS="make pkgconf libtool pcre libressl libxml2 libevent geoip nghttp2"
DEF_CONFIGURE_ARGS="--modules-path=${PREFIX}/modules --with-compat --with-pcre --with-threads --with-poll_module --without-select_module --with-http_ssl_module --with-http_gzip_static_module --with-http_gunzip_module --with-http_geoip_module --with-http_realip_module --with-stream --with-stream_ssl_module --without-http_scgi_module --without-http_uwsgi_module --with-http_slice_module --with-http_secure_link_module --with-http_auth_request_module --with-http_addition_module --with-http_v2_module --with-http_realip_module --with-http_addition_module --with-http_stub_status_module --with-stream_geoip_module --without-mail_pop3_module --without-mail_imap_module --without-mail_smtp_module"
DEF_MAKE_METHOD="OPENSSL=${PREFIX} && make -s ${MAKE_OPTS}"
DEF_AFTER_MAKE_METHOD="after_make"
after_make () {
    for pref in /proxy /body /body /fcgi /logs; do
        ${MKDIR_BIN} -p "${SERVICE_DIR}${pref}"
    done
}

DEF_AFTER_UNPACK_METHOD="patch_modules"
patch_modules () {
    ${SED_BIN} -i '' -e "s#/usr/local#${PREFIX}#g" auto/lib/geoip/conf
    ${SED_BIN} -i '' -e "s#/usr/local#${PREFIX}#g" auto/lib/pcre/conf
    ${SED_BIN} -i '' -e "s#/usr/local#${PREFIX}#g" auto/lib/zlib/conf
}

svd_args="--error-log-path=${SERVICE_DIR}/logs/error.log --http-log-path=${SERVICE_DIR}/logs/access.log --pid-path=${SERVICE_DIR}/service.pid --lock-path=${SERVICE_DIR}/service.lock --conf-path=${SERVICE_DIR}/service.conf --http-proxy-temp-path=${SERVICE_DIR}/proxy --http-client-body-temp-path=${SERVICE_DIR}/body --http-fastcgi-temp-path=${SERVICE_DIR}/fcgi"
common_args="--with-cc-opt='${DEFAULT_COMPILER_FLAGS} -fPIE' --with-ld-opt='${LDFLAGS} -R${PREFIX}/lib ${DEFAULT_LDFLAGS} -pie'"
case "${SYSTEM_NAME}" in
    Darwin)
        DEF_CONFIGURE_ARGS="${DEF_CONFIGURE_ARGS} --user=nobody --group=nogroup ${svd_args}"
        ;;

    Linux)
        DEF_CONFIGURE_ARGS="${DEF_CONFIGURE_ARGS} --user=www-data --group=www-data --with-file-aio --with-openssl=${PREFIX} --with-zlib=${PREFIX} ${common_args}"
        ;;

    FreeBSD)
        DEF_CONFIGURE_ARGS="${DEF_CONFIGURE_ARGS} --with-file-aio --user=www --group=www --build=VerKnowSys ${common_args} ${svd_args}"
        ;;
esac
DEF_EXPORTS="nginx"
DEF_CONFLICTS_WITH="Httpd"
DEF_USE_SAFE_STACK=YES
