DEF_FULL_NAME="Erlang OTP"
DEF_SHA="6f394857b2910de27b39275cdad9ed05be95bcda"
DEF_NAME="otp"
PATCHES_SITE="https://olgeni.olgeni.com/~olgeni/distfiles/"
MAJOR="19.3"
DEF_VERSION="${MAJOR}.0"
DEF_SOURCE_PATH="${MAIN_SOURCE_REPOSITORY}${DEF_NAME}_src_${MAJOR}.tar.gz" # NOTE: For non-tarball versions use: "./otp_build autoconf" to gen configure
DEF_REQUIREMENTS="pkgconf make m4 libtool zlib lzma lzo xz gettext db gdbm libunwind libatomic_ops libressl unixodbc perl libxml2 libgpg-error libgcrypt libxslt"
DEF_AFTER_UNPACK_METHOD="./otp_build remove_prebuilt_files || :"
DEF_CONFIGURE_ARGS="--enable-threads --with-dynamic-trace=dtrace --enable-fp-exceptions --enable-hipe --enable-kernel-poll --enable-smp-support --enable-sctp --with-ssl=${PREFIX} --disable-debug --enable-vm-probes --with-odbc=${PREFIX} --enable-native-libs --with-libatomic_ops=${PREFIX}"
DEF_INSTALL_METHOD="LANG=en_GB.UTF-8 make -s install && install_repl_history"
DEF_EXPORTS="ct_run dialyzer epmd erl erlc escript run_erl to_erl typer"
DEF_CONFLICTS_WITH="Otp Elixir"
DEF_USELESS="lib/*perl* docs share"
DEF_NO_LTO=YES
DEF_NO_CCACHE=YES
case "${SYSTEM_NAME}" in
    FreeBSD)
        DEF_COMPILER_ARGS="-fPIC -fPIE -DMAP_NORESERVE=8 -fno-omit-frame-pointer -fsanitize=safe-stack"
        DEF_SYSTEM_SPECIFIC_CFLAGS="${DEF_COMPILER_ARGS} ${DEF_OPTFLAGS} -fsanitize=safe-stack"
        DEF_SYSTEM_SPECIFIC_CXXFLAGS="${DEF_COMPILER_ARGS} ${DEF_OPTFLAGS} -fsanitize=safe-stack"
        DEF_SYSTEM_SPECIFIC_LDFLAGS="-L${PREFIX}/lib -L/usr/lib -ldtrace -lc++ -lc -lm"
        DEF_LINKER_ARGS="${DEF_SYSTEM_SPECIFIC_LDFLAGS} -pie -fsanitize=safe-stack"

        # NOTE: this causes a hickup for HIPE:
        # erl_prettypr.erl: internal error in native_compile;
        # crash reason: undef
        # (...)
        #
        # DEF_CONFIGURE_ARGS="${DEF_CONFIGURE_ARGS} --enable-m64-build"
        # DEF_CONFIGURE_ARGS="${DEF_CONFIGURE_ARGS} --exec-prefix=${PREFIX}"
        # DEF_LINKER_ARGS="-L${PREFIX}/lib -L/usr/lib -ldtrace -lpthread"
        # DEF_SYSTEM_SPECIFIC_LDFLAGS="-L/usr/lib -ldtrace"
        ;;

    # Darwin)
    #     DEF_CONFIGURE_ARGS="${DEF_CONFIGURE_ARGS} --with-wxwidgets=${PREFIX}"
    #     ;;

    *)
        DEF_COMPILER_ARGS="${DEF_COMPILER_ARGS} -fno-omit-frame-pointer"
        DEF_LINKER_ARGS="-L${PREFIX}/lib -L/usr/lib -ldtrace -lpthread"
        ;;
esac

HISTORY_PLUGIN_SOURCE="https://github.com/VerKnowSys/erlang-history"
install_repl_history () {
    try "${GIT_BIN} clone ${HISTORY_PLUGIN_SOURCE}"
    cd erlang-history
    try "PATH=$PATH:${PREFIX}/bin:/bin make install"
}
