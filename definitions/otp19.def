DEF_FULL_NAME="Erlang OTP"
DEF_SHA="6f394857b2910de27b39275cdad9ed05be95bcda"
DEF_NAME="otp"
PATCHES_SITE="https://olgeni.olgeni.com/~olgeni/distfiles/"
DEF_STANDALONE=YES
MAJOR="19.3"
MINOR="6.x"
DEF_VERSION="${MAJOR}.${MINOR}"
DEF_SOURCE_PATH="${MAIN_SOURCE_REPOSITORY}${DEF_NAME}_src_${MAJOR}.tar.gz"
DEF_REQUIREMENTS="jemalloc lzo libxml2 libressl perl bison flex"
DEF_CONFIGURE_ARGS="--enable-threads --enable-smp-support --with-ssl=${PREFIX} --with-ssl-rpath=${PREFIX}/lib --enable-native-libs --without-odbc --without-docs --enable-sctp"
DEF_INSTALL_METHOD="make -s install && install_repl_history"
DEF_EXPORTS="ct_run dialyzer epmd erl erlc escript run_erl to_erl typer"
DEF_CONFLICTS_WITH="Otp Elixir"
DEF_USEFUL="bin/bison bin/yacc bin/flex"
DEF_USELESS="lib/*perl* docs share include lib/*.a lib/libffi* lib/cmake"
unset DEF_USE_LTO
DEF_NO_TRAP_INT_OVERFLOW=YES
DEF_NO_CCACHE=YES
DEF_NO_LLVM_LINKER=YES
DEF_TEST_METHOD="make release_tests"
case "${SYSTEM_NAME}" in
    FreeBSD)
        # DEF_USE_SAFE_STACK=YES
        DEF_COMPILER_FLAGS="${DEF_OPTFLAGS} -fPIC -fPIE -DMAP_NORESERVE=0 -fno-omit-frame-pointer"
        DEF_LINKER_FLAGS="-L${PREFIX}/lib -L/usr/lib -ldtrace -lthr -lpthread"
        DEF_MAKE_METHOD="ERL_TOP=${PWD} make -j${CPUS}"
        DEF_CONFIGURE_ARGS="${DEF_CONFIGURE_ARGS} --disable-wx --disable-java --enable-hipe --with-dynamic-trace=dtrace --enable-m64-build --enable-kernel-poll"
        ;;

    Darwin)
        # DEF_REQUIREMENTS="${DEF_REQUIREMENTS} jpeg jbig2dec jbigkit nasm libjpeg-turbo tiff libpng wxwidgets"
        # DEF_CONFIGURE_ARGS="${DEF_CONFIGURE_ARGS} --enable-wx --enable-java --enable-darwin-64bit --enable-hipe --with-dynamic-trace=dtrace"
        DEF_CONFIGURE_ARGS="${DEF_CONFIGURE_ARGS} --enable-darwin-64bit --enable-hipe --with-dynamic-trace=dtrace"
        ;;
esac

DEF_NO_DISALLOW_MAP32BIT=YES
DEF_NO_MPROTECT=YES
DEF_NO_PAGEEXEC=YES
DEF_NO_ASLR=YES
DEF_APPLY_LOWER_SECURITY_ON="${DEF_EXPORTS} erl erlc beam beam.smp run_erl ct_run"

HISTORY_PLUGIN_SOURCE="https://github.com/VerKnowSys/erlang-history"
install_repl_history () {
    try "${GIT_BIN} clone ${HISTORY_PLUGIN_SOURCE}"
    cd erlang-history
    note "Installing erlang-history plugin"
    try "PATH=$PATH:${PREFIX}/bin:/bin make install"
}
