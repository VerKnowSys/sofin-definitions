APP_FULL_NAME="Rust Language"
APP_SHA="fadca2ef0f632b25e6a4dd4e2d8ab8ea218dd4a6"
APP_NAME="rust"
APP_VERSION="1.6.0"
APP_HTTP_PATH="${MAIN_SOURCE_REPOSITORY}${APP_NAME}c-${APP_VERSION}-src.tar.gz"
CARGO_REPOSITORY="https://github.com/rust-lang/cargo"
APP_REQUIREMENTS="pkgconf m4 gmake libunwind jemalloc ccache libiconv python27 libxml2 cmake libssh2 libressl perl texinfo libidn curl bison llvm"
APP_CONFIGURE_ARGS="--disable-stage0-landing-pads --disable-manage-submodules --release-channel=stable --enable-optimize --enable-optimize-tests --enable-optimize-cxx --enable-optimize-llvm --disable-valgrind --disable-valgrind-rpass --enable-clang --disable-docs --enable-rpath --musl-root=${PREFIX} --python=${PREFIX}/bin/python --enable-ccache --llvm-root=${PREFIX} --jemalloc-root=${PREFIX}/lib --datadir=${SERVICE_DIR}/share --infodir=${SERVICE_DIR}/share/info"
APP_CONFIGURE_SCRIPT="./configure"
APP_MAKE_METHOD="RUSTFLAGS=-Ccodegen_units=${CPUS} gmake ${MAKE_OPTS}"
APP_INSTALL_METHOD="PREFIX=${PREFIX} gmake install ${MAKE_OPTS}"
APP_EXPORTS="rustc rust-gdb rustdoc cargo cargo.bin"
APP_COMPILER_ARGS="-I${PREFIX}/include"
APP_LINKER_ARGS="-L${PREFIX}/lib"
APP_USELESS="doc man ssl include/python* lib/python* share/au* share/bison share/ac* share/info share/*doc share/man share/cmake* include/perl* lib/perl*"
APP_CONFLICTS_WITH="Rust"

APP_AFTER_INSTALL_CALLBACK="install_cargo"
install_cargo () {
    export PATH="${PREFIX}/bin:/usr/bin:/bin:$(${DIRNAME_BIN} ${GIT_BIN})"
    export PKG_CONFIG_EXECUTABLE="${PREFIX}/bin/pkgconf"
    export CARGO_SNAPSHOT="${MAIN_SOURCE_REPOSITORY}cargo-nightly-x86_64-unknown-freebsd.tar.gz"
    export CARGO_FBSD_PATCH="${MAIN_SOURCE_REPOSITORY}cargo_freebsd_support_patch.patch"
    ${LN_BIN} -s ${PREFIX}/lib/libcurl.so.8 ${PREFIX}/lib/libcurl.so.4
    debug "Cloning Cargo from remote repository.."
    ${GIT_BIN} clone ${CARGO_REPOSITORY}
    cd cargo
    ${GIT_BIN} submodule update --init

    debug "Patching Cargo for FreeBSD"
    ${FETCH_BIN} "${CARGO_FBSD_PATCH}"
    ${PATCH_BIN} -p0 < cargo_freebsd_support_patch.patch

    debug "Downloading Cargo snapshot from: ${CARGO_SNAPSHOT}"
    ${MKDIR_BIN} -p target/dl
    cd target/dl
    ${FETCH_BIN} "${CARGO_SNAPSHOT}"
    cd ../..

    ${PRINTF_BIN} "2015-04-02
  freebsd-x86_64 2e0ade0901864ea67200f990cb289343b08959e7
" > src/snapshots.txt

    debug "Configuring Cargo.." && \
    ./configure --prefix=${PREFIX} --local-rust-root=${PREFIX} && \
    unset CC && \
    debug "Building Cargo using ${CPUS} cpus.." && \
    RUSTFLAGS=-Ccodegen_units=${CPUS} ${PREFIX}/bin/gmake && \
    debug "Installing Rust.." && \
    ${PREFIX}/bin/gmake install
    ret="$?"

    # make wrapper for cargo which does not include rpath information in binary:
    ${MV_BIN} ${PREFIX}/bin/cargo ${PREFIX}/bin/cargo.bin
    ${PRINTF_BIN} "#\!/bin/sh\nLD_LIBRARY_PATH=${PREFIX}/lib ${PREFIX}/bin/cargo.bin \$*\n" > ${PREFIX}/bin/cargo
    ${CHMOD_BIN} 755 ${PREFIX}/bin/cargo

    return ${ret}
}

