DEF_FULL_NAME="Rust + Cargo + Utilities"
DEF_NAME="rust"
DEF_VERSION="1.31.0"
DEF_SHA="69b2df73541a16a568b13cb1eadc5455f655c6f6"
DEF_SOURCE_PATH="${MAIN_SOURCE_REPOSITORY}${DEF_NAME}-${DEF_VERSION}-x86_64-unknown-freebsd.tar.gz"
DEF_STANDALONE=YES
DEF_CONFIGURE_METHOD="binary"
DEF_USE_SAFE_STACK=YES
DEF_CLEAN_USELESS=NO
DEF_EXPORTS="rustc cargo cargo.bin cargo-count cargo-do cargo-check cargo-modules cargo-watch cargo-fmt rustfmt rls rust-gdb rust-lldb rustdoc rg everustc bat cargo-asm cargo-audit fd cargo-clippy clippy-driver cargo-llvm-ir bindgen run-cargo-script cargo-script"
DEF_CONFLICTS_WITH="Rust"

# NOTE: rustdoc has issues on hardened systems, so disabling mprotect for it:
DEF_NO_MPROTECT=YES
DEF_APPLY_LOWER_SECURITY_ON="rustdoc"


DEF_AFTER_UNPACK_METHOD="patch_prefix_and_install"
patch_prefix_and_install () {
    ${SED_BIN} -i '' -e "s|/bin/bash|/bin/sh|; s|/usr/local|${PREFIX}|g" install.sh
    note "Installing Rust v${DEF_VERSION}"
    try "./install.sh >> ${LOG}-${DEF_NAME}"
}


DEF_AFTER_MAKE_METHOD="create_cargo_bin_wrapper; install_utils"
create_cargo_bin_wrapper () {
    try "${MV_BIN} -f \"${PREFIX}/bin/cargo\" \"${PREFIX}/bin/cargo.bin\"" \
        && printf "#!/usr/bin/env sh \n\
#\n\
# Cargo - Rust Package Manager.\n\
# This is a wrapper for: ${PREFIX}/exports/${DEF_NAME}.bin - that lacks RPATH data in ELF header \n\
# Author: @dmilith \n\
# \n\
CC=cc \\
CPP=cpp \\
CXX=c++ \\
CFLAGS=\"${DEF_COMPILER_FLAGS}\" \\
CXXFLAGS=\"${DEF_COMPILER_FLAGS}\" \\
LDFLAGS=\"${DEF_LINKER_FLAGS}\" \\
RUST_BACKTRACE=\"\${RUST_BACKTRACE:-1}\" \\
RUSTFLAGS=\"\${RUSTFLAGS:-\"${DEFAULT_RUSTFLAGS}\"}\" \\
CARGO_BUILD_JOBS=\"\${CARGO_BUILD_JOBS:-\"${CPUS}\"}\" \\
CARGO_INSTALL_ROOT=\"\${CARGO_INSTALL_ROOT:-\"${SERVICE_DIR}\"}\" \\
${PREFIX}/bin/cargo.bin \${@} \n" > "${PREFIX}/bin/cargo"
    try "${CHMOD_BIN} -v 755 \"${PREFIX}/bin/cargo\""
}

install_utils () {
    note "Installing: $(distn "cargo-audit, cargo-asm, cargo-watch, cargo-do, rustfmt, cargo-count, bat, rg and fd-find")"
    for _add in cargo-audit cargo-asm cargo-watch cargo-do rustfmt cargo-count ripgrep everustc bat rg fd-find bindgen cargo-script; do
        if [ ! -x "${SERVICE_DIR}/bin/${_add}" ]; then
            note "Building utility: $(distn "${_add}")"
            try "PATH=${PREFIX}/bin:/bin:/usr/bin cargo install --force ${_add} >> ${LOG}-${DEF_NAME}"
        fi
    done
}
