APP_FULL_NAME="Rust Language"
APP_SHA="de1cbc378a1c5797578f0b7e8ab397a919c77ecf"
APP_NAME="rust"
APP_VERSION="1.4.0"
APP_HTTP_PATH="${MAIN_SOURCE_REPOSITORY}${APP_NAME}c-${APP_VERSION}-src.tar.gz"
APP_REQUIREMENTS="gmake pkgconf libiconv python27 curl llvm m4 libressl ccache cmake libssh2" # libgit2
APP_CONFIGURE_SCRIPT="PATH=${PREFIX}/bin:/Software/Git/bin:${PATH} ./configure"
APP_MAKE_METHOD="RUSTFLAGS=-Ccodegen_units=${CPUS} gmake ${MAKE_OPTS}"
APP_INSTALL_METHOD="gmake install ${MAKE_OPTS}"
APP_CONFIGURE_ARGS="--disable-valgrind --enable-clang --disable-docs --release-channel=stable --disable-optimize-tests --enable-rpath --llvm-root=${PREFIX} --musl-root=${PREFIX} --python=${PREFIX}/bin/python --enable-ccache"
APP_EXPORTS="rustc rust-gdb rustdoc cargo cargo.bin"
APP_USELESS="lib/perl* lib/python* share/bison share/aclocal share/info share/doc/flex"
APP_CONFLICTS_WITH="Rust"

APP_AFTER_INSTALL_CALLBACK="install_cargo"
install_cargo () {
    export PATH=${PREFIX}/bin:/usr/bin:/bin:/Software/Git/bin
    export PKG_CONFIG_EXECUTABLE=${PREFIX}/bin/pkgconf
    ${LN_BIN} -s ${PREFIX}/lib/libcurl.so.8 ${PREFIX}/lib/libcurl.so.4
    ${GIT_BIN} clone https://github.com/rust-lang/cargo
    cd cargo
    ${GIT_BIN} submodule update --init
    ./configure --prefix=${PREFIX} --local-rust-root=${PREFIX}
    unset CC
    RUSTFLAGS=-Ccodegen_units=${CPUS} ${PREFIX}/bin/gmake
    ${PREFIX}/bin/gmake install

    # make wrapper for cargo which doesn't include rpath information in binary:
    ${MV_BIN} ${PREFIX}/bin/cargo ${PREFIX}/bin/cargo.bin
    ${PRINTF_BIN} "#\!/bin/sh\nLD_LIBRARY_PATH=${PREFIX}/lib ${PREFIX}/bin/cargo.bin \$*\n" > ${PREFIX}/bin/cargo
    ${CHMOD_BIN} 755 ${PREFIX}/bin/cargo
}
