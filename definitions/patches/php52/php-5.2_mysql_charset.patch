--- ext/mysql/php_mysql.c	2013-03-20 15:28:51.889749077 +0100
+++ ext/mysql/php_mysql.c	2013-03-20 15:29:06.713749255 +0100
@@ -360,6 +360,7 @@
 	PHP_INI_ENTRY("mysql.default_port",				NULL,	PHP_INI_ALL,		OnMySQLPort)
 	STD_PHP_INI_ENTRY("mysql.default_socket",		NULL,	PHP_INI_ALL,		OnUpdateStringUnempty,	default_socket,	zend_mysql_globals,		mysql_globals)
 	STD_PHP_INI_ENTRY("mysql.connect_timeout",		"60",	PHP_INI_ALL,		OnUpdateLong,		connect_timeout, 	zend_mysql_globals,		mysql_globals)
+	STD_PHP_INI_ENTRY("mysql.connect_charset",		NULL,	PHP_INI_ALL,		OnUpdateString,		connect_charset,	zend_mysql_globals,		mysql_globals)
 	STD_PHP_INI_BOOLEAN("mysql.trace_mode",			"0",	PHP_INI_ALL,		OnUpdateLong,		trace_mode, 		zend_mysql_globals,		mysql_globals)
 PHP_INI_END()
 /* }}} */
@@ -376,6 +377,7 @@
 	mysql_globals->connect_errno = 0;
 	mysql_globals->connect_error = NULL;
 	mysql_globals->connect_timeout = 0;
+	mysql_globals->connect_charset = NULL;
 	mysql_globals->trace_mode = 0;
 	mysql_globals->result_allocated = 0;
 }
@@ -515,6 +517,7 @@
 {
 	char *user=NULL, *passwd=NULL, *host_and_port=NULL, *socket=NULL, *tmp=NULL, *host=NULL;
 	int  user_len, passwd_len, host_len;
+	char *connect_charset=NULL;
 	char *hashed_details=NULL;
 	int hashed_details_length, port = MYSQL_PORT;
 	long client_flags = 0;
@@ -527,6 +530,7 @@
 
 
 	connect_timeout = MySG(connect_timeout);
+	connect_charset = MySG(connect_charset);
 
 	socket = MySG(default_socket);
 
@@ -644,6 +648,9 @@
 				mysql_options(&mysql->conn, MYSQL_OPT_CONNECT_TIMEOUT, (const char *)&connect_timeout);
 			}
 
+			if (connect_charset != NULL)
+				mysql_options(&mysql->conn, MYSQL_SET_CHARSET_NAME, connect_charset);
+
 			if (mysql_real_connect(&mysql->conn, host, user, passwd, NULL, port, socket, client_flags)==NULL) {
 #else
 			if (mysql_connect(&mysql->conn, host, user, passwd)==NULL) {
@@ -688,6 +695,9 @@
 				signal(SIGPIPE, handler);
 #endif /* end mysql_ping */
 #if MYSQL_VERSION_ID > 32199 /* this lets us set the port number */
+				if (connect_charset != NULL)
+					mysql_options(le->ptr, MYSQL_SET_CHARSET_NAME, connect_charset);
+
 				if (mysql_real_connect(le->ptr, host, user, passwd, NULL, port, socket, client_flags)==NULL) {
 #else
 				if (mysql_connect(le->ptr, host, user, passwd)==NULL) {
@@ -751,6 +761,9 @@
 			mysql_options(&mysql->conn, MYSQL_OPT_CONNECT_TIMEOUT, (const char *)&connect_timeout);
 		}
 
+		if (connect_charset != NULL)
+			mysql_options(&mysql->conn, MYSQL_SET_CHARSET_NAME, connect_charset);
+
 		if (mysql_real_connect(&mysql->conn, host, user, passwd, NULL, port, socket, client_flags)==NULL) {
 #else
 		if (mysql_connect(&mysql->conn, host, user, passwd)==NULL) {
--- ext/mysql/php_mysql_structs.h	2013-03-20 15:28:51.889749077 +0100
+++ ext/mysql/php_mysql_structs.h	2013-03-20 15:29:06.713749255 +0100
@@ -103,6 +103,7 @@
 	long default_port;
 	char *default_host, *default_user, *default_password;
 	char *default_socket;
+	char *connect_charset;
 	char *connect_error;
 	long connect_errno;
 	long connect_timeout;
--- ext/mysqli/mysqli_api.c	2013-03-20 15:28:52.065749075 +0100
+++ ext/mysqli/mysqli_api.c	2013-03-20 15:29:06.725749273 +0100
@@ -1424,7 +1424,7 @@
 PHP_FUNCTION(mysqli_real_connect)
 {
 	MY_MYSQL 		*mysql;
-	char 			*hostname = NULL, *username=NULL, *passwd=NULL, *dbname=NULL, *socket=NULL;
+	char 			*hostname = NULL, *username=NULL, *passwd=NULL, *dbname=NULL, *socket=NULL, *connect_charset=NULL;
 	unsigned int 	hostname_len = 0, username_len = 0, passwd_len = 0, dbname_len = 0, socket_len = 0;
 	unsigned long 	port=0, flags=0;
 	zval			*mysql_link;
@@ -1474,6 +1474,12 @@
 		socket = MyG(default_socket);
 	}
 
+	connect_charset = MyG(connect_charset);
+
+	if (connect_charset != NULL) {
+		mysql_options(mysql->mysql, MYSQL_SET_CHARSET_NAME, connect_charset);
+	}
+
 	if (mysql_real_connect(mysql->mysql,hostname,username,passwd,dbname,port,socket,flags) == NULL) {
 		php_mysqli_set_error(mysql_errno(mysql->mysql), (char *) mysql_error(mysql->mysql) TSRMLS_CC);
 		php_mysqli_throw_sql_exception( mysql->mysql->net.sqlstate, mysql->mysql->net.last_errno TSRMLS_CC,
--- ext/mysqli/mysqli.c	2013-03-20 15:28:52.065749075 +0100
+++ ext/mysqli/mysqli.c	2013-03-20 15:29:06.725749273 +0100
@@ -451,6 +451,7 @@
 	STD_PHP_INI_ENTRY("mysqli.default_pw",				NULL,	PHP_INI_ALL,		OnUpdateString,		default_pw,			zend_mysqli_globals,		mysqli_globals)
 	STD_PHP_INI_ENTRY("mysqli.default_port",			"3306",	PHP_INI_ALL,		OnUpdateLong,		default_port,		zend_mysqli_globals,		mysqli_globals)
 	STD_PHP_INI_ENTRY("mysqli.default_socket",			NULL,	PHP_INI_ALL,		OnUpdateStringUnempty,	default_socket,	zend_mysqli_globals,		mysqli_globals)
+	STD_PHP_INI_ENTRY("mysqli.connect_charset",			NULL,	PHP_INI_ALL,		OnUpdateString,		connect_charset,	zend_mysqli_globals,		mysqli_globals)
 	STD_PHP_INI_BOOLEAN("mysqli.reconnect",				"0",	PHP_INI_SYSTEM,		OnUpdateLong,		reconnect,			zend_mysqli_globals,		mysqli_globals)
 PHP_INI_END()
 
@@ -467,6 +468,7 @@
 	mysqli_globals->default_user = NULL;
 	mysqli_globals->default_pw = NULL;
 	mysqli_globals->default_socket = NULL;
+	mysqli_globals->connect_charset = NULL;
 	mysqli_globals->reconnect = 0;
 	mysqli_globals->report_mode = 0;
 	mysqli_globals->report_ht = 0;
--- ext/mysqli/mysqli_nonapi.c	2013-03-20 15:28:52.065749075 +0100
+++ ext/mysqli/mysqli_nonapi.c	2013-03-20 15:29:06.725749273 +0100
@@ -36,7 +36,7 @@
 	MY_MYSQL 			*mysql = NULL;
 	MYSQLI_RESOURCE 	*mysqli_resource = NULL;
 	zval  				*object = getThis();
-	char 				*hostname = NULL, *username=NULL, *passwd=NULL, *dbname=NULL, *socket=NULL;
+	char 				*hostname = NULL, *username=NULL, *passwd=NULL, *dbname=NULL, *socket=NULL, *connect_charset=NULL;
 	unsigned int 		hostname_len = 0, username_len = 0, passwd_len = 0, dbname_len = 0, socket_len = 0;
 	long				port=0;
 
@@ -116,6 +116,12 @@
 		socket = MyG(default_socket);
 	}
 
+	connect_charset = MyG(connect_charset);
+
+	if (connect_charset != NULL) {
+		mysql_options(mysql->mysql, MYSQL_SET_CHARSET_NAME, connect_charset);
+	}
+
 	if (mysql_real_connect(mysql->mysql,hostname,username,passwd,dbname,port,socket,CLIENT_MULTI_RESULTS) == NULL) {
 		/* Save error messages */
 
--- ext/mysqli/php_mysqli.h	2013-03-20 15:28:52.065749075 +0100
+++ ext/mysqli/php_mysqli.h	2013-03-20 15:29:06.725749273 +0100
@@ -442,6 +442,7 @@
 	char			*default_user;
 	char			*default_socket;
 	char            *default_pw;
+	char			*connect_charset;
 	int				reconnect;
 	int				strict;
 	long			error_no;
--- ext/pdo_mysql/mysql_driver.c	2013-03-20 15:28:51.901749074 +0100
+++ ext/pdo_mysql/mysql_driver.c	2013-03-20 15:29:06.725749273 +0100
@@ -436,6 +436,7 @@
 	pdo_mysql_db_handle *H;
 	int i, ret = 0;
 	char *host = NULL, *unix_socket = NULL;
+	char *connect_charset = NULL;
 	unsigned int port = 3306;
 	char *dbname;
 	struct pdo_data_src_parser vars[] = {
@@ -550,6 +551,13 @@
 	if (vars[2].optval && !strcmp("localhost", vars[2].optval)) {
 		unix_socket = vars[4].optval;  
 	}
+
+	connect_charset = PDOMYSQLG(connect_charset);
+
+	if (connect_charset != NULL) {
+		mysql_options(H->server, MYSQL_SET_CHARSET_NAME, connect_charset);
+	}
+
 	if (mysql_real_connect(H->server, host, dbh->username, dbh->password, dbname, port, unix_socket, connect_opts) == NULL) {
 		pdo_mysql_error(dbh);
 		goto cleanup;
--- ext/pdo_mysql/pdo_mysql.c	2013-03-20 15:28:51.901749074 +0100
+++ ext/pdo_mysql/pdo_mysql.c	2013-03-20 15:29:06.725749273 +0100
@@ -30,6 +30,9 @@
 #include "php_pdo_mysql.h"
 #include "php_pdo_mysql_int.h"
 
+ZEND_DECLARE_MODULE_GLOBALS(pdo_mysql)
+static PHP_GINIT_FUNCTION(pdo_mysql);
+
 /* {{{ pdo_mysql_functions[] */
 zend_function_entry pdo_mysql_functions[] = {
 	{NULL, NULL, NULL}
@@ -61,7 +64,11 @@
 	NULL,
 	PHP_MINFO(pdo_mysql),
 	"1.0.2",
-	STANDARD_MODULE_PROPERTIES
+	PHP_MODULE_GLOBALS(pdo_mysql),
+	PHP_GINIT(pdo_mysql),
+	NULL,
+	NULL,
+	STANDARD_MODULE_PROPERTIES_EX
 };
 /* }}} */
 
@@ -69,12 +76,23 @@
 ZEND_GET_MODULE(pdo_mysql)
 #endif
 
+PHP_INI_BEGIN()
+	STD_PHP_INI_ENTRY("pdo_mysql.connect_charset",	NULL,	PHP_INI_ALL,	OnUpdateString,	connect_charset,	zend_pdo_mysql_globals,	pdo_mysql_globals)
+PHP_INI_END()
+
+static PHP_GINIT_FUNCTION(pdo_mysql)
+{
+	pdo_mysql_globals->connect_charset = NULL;
+}
+
 /* true global environment */
 
 /* {{{ PHP_MINIT_FUNCTION
  */
 PHP_MINIT_FUNCTION(pdo_mysql)
 {
+	REGISTER_INI_ENTRIES();
+
 	REGISTER_PDO_CLASS_CONST_LONG("MYSQL_ATTR_USE_BUFFERED_QUERY", (long)PDO_MYSQL_ATTR_USE_BUFFERED_QUERY);
 	REGISTER_PDO_CLASS_CONST_LONG("MYSQL_ATTR_LOCAL_INFILE", (long)PDO_MYSQL_ATTR_LOCAL_INFILE);
 	REGISTER_PDO_CLASS_CONST_LONG("MYSQL_ATTR_INIT_COMMAND", (long)PDO_MYSQL_ATTR_INIT_COMMAND);
@@ -91,6 +109,7 @@
  */
 PHP_MSHUTDOWN_FUNCTION(pdo_mysql)
 {
+	UNREGISTER_INI_ENTRIES();
 	php_pdo_unregister_driver(&pdo_mysql_driver);
 	return SUCCESS;
 }
@@ -103,6 +122,8 @@
 	php_info_print_table_start();
 	php_info_print_table_header(2, "PDO Driver for MySQL, client library version", mysql_get_client_info());
 	php_info_print_table_end();
+
+	DISPLAY_INI_ENTRIES();
 }
 /* }}} */
 
--- ext/pdo_mysql/php_pdo_mysql.h	2013-03-20 15:28:51.901749074 +0100
+++ ext/pdo_mysql/php_pdo_mysql.h	2013-03-20 15:29:06.725749273 +0100
@@ -40,6 +40,18 @@
 PHP_RSHUTDOWN_FUNCTION(pdo_mysql);
 PHP_MINFO_FUNCTION(pdo_mysql);
 
+ZEND_BEGIN_MODULE_GLOBALS(pdo_mysql)
+	char	*connect_charset;
+ZEND_END_MODULE_GLOBALS(pdo_mysql)
+
+#ifdef ZTS
+# define PDOMYSQLG(v) TSRMG(pdo_mysql_globals_id, zend_pdo_mysql_globals *, v)
+#else
+# define PDOMYSQLG(v) (pdo_mysql_globals.v)
+#endif
+
+ZEND_EXTERN_MODULE_GLOBALS(pdo_mysql)
+
 #endif	/* PHP_PDO_MYSQL_H */
 
 
