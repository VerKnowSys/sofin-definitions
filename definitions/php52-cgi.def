APP_FULL_NAME="PHP 5.2"
APP_SHA="d68f3b09f766990d815a3c4c63c157db8dab8095"
APP_NAME="php"
APP_VERSION="5.2.17"
APP_POSTFIX="52"
APP_HTTP_PATH="${MAIN_SOURCE_REPOSITORY}${APP_NAME}-${APP_VERSION}.tar.bz2"
APP_CONFIGURE_ARGS="--disable-all --with-libdir=${PREFIX}/lib --with-layout=PHP --with-libxml-dir=${PREFIX} --with-pcre-regex --enable-filter --with-pcre-dir=${PREFIX} --with-zlib-dir=${PREFIX} --with-gettext=${PREFIX} --with-gd --with-png-dir=${PREFIX} --with-jpeg-dir=${PREFIX} --enable-exif --enable-zip --without-apache --disable-debug --enable-sockets --enable-soap --enable-json --enable-libxml --enable-dom --enable-session --enable-hash --enable-simplexml --enable-xml --enable-filter --enable-pdo --with-pdo-mysql=${PREFIX} --with-pdo-pgsql=${PREFIX} --enable-mbstring --with-openssl --with-mcrypt=${PREFIX} --with-mysql=mysqlnd --with-mysqli=mysqlnd --with-pgsql=${PREFIX} --with-config-file-path=${PREFIX} --with-curl=${PREFIX} --with-gmp=${PREFIX} --with-freetype-dir=${PREFIX} --with-pear --with-xsl=${PREFIX} --enable-posix --with-bz2 --enable-ftp --enable-calendar --enable-bcmath --enable-wddx --enable-zip --with-mssql=${PREFIX} --with-xmlrpc --with-iconv --disable-maintainer-zts --disable-roxen-zts --enable-ctype --with-mhash=${PREFIX} --enable-tokenizer --enable-xmlwriter --enable-xmlreader --enable-sqlite-utf8 --with-sqlite=${PREFIX} --with-pdo-sqlite=${PREFIX} --with-ldap=${PREFIX} --with-ldap-sasl=${PREFIX} --with-imap-ssl=${PREFIX} --with-imap=${PREFIX} --without-kerberos --with-mysql=${PREFIX} --with-mysqli=${PREFIX}/bin/mysql_config --enable-cli --without-apxs2 --enable-cgi --enable-fastcgi --enable-spl"
APP_REQUIREMENTS="gmake perl libiconv pkgconf zlib gettext bzip2 m4 autoconf bison flex postgresql93 libxml2 libtool libgpg-error libgcrypt libxslt pcre libexif libpng jpeg freetype fontconfig gd cmake ncurses mysql icu libmcrypt openssl curl gmp tiff jasper imagemagick freetds sqlite2 sqlite cyrus-sasl openldap geoip cclient autoconf213" # NOTE: this autoconf23 is required here, cause php 5.2 buildconf script requires that to generate configure script correctly. Also newer version is required earlier by gmp.
APP_INSTALL_METHOD="gmake install -s"
APP_EXPORTS="php php-cgi php-config phpize pecl pear lsphp"
APP_NO_CCACHE="YES"

APP_AFTER_UNPACK_CALLBACK="hack_after_unpack"
hack_after_unpack () {
    # HACK: Required to detect freetds (don't blame me, but Php/TDS guys for messed up library detection)
    ${MKDIR_BIN} -p ${PREFIX}/Software
    ${LN_BIN} -s ${PREFIX} ${PREFIX}/Software || true

    note "Hacking GMP"
    sed -i 's/__GMP_BITS_PER_MP_LIMB/GMP_LIMB_BITS/g' ext/gmp/gmp.c

    note "Regenerating configure script"
    touch ac*
    PATH=${PREFIX}/bin:/bin:/usr/bin:/usr/sbin:/sbin ./buildconf --force
}
APP_AFTER_CONFIGURE_CALLBACK="${RM_BIN} -rf ${PREFIX}/Software || true"

# install extensions
APP_AFTER_INSTALL_CALLBACK="install_extensions"


install_geoip () {
    PATH=$PATH:${PREFIX}/bin:/bin echo ${PREFIX} | ${PREFIX}/bin/pecl install geoip
    test "$?" = "0" || error "Error building geoip"
}

install_imagick () {
    PATH=$PATH:${PREFIX}/bin echo ${PREFIX} | ${PREFIX}/bin/pecl install imagick
    test "$?" = "0" || error "Error building imagick"
}

install_rar () {
    PATH=$PATH:${PREFIX}/bin echo ${PREFIX} | ${PREFIX}/bin/pecl install rar
    test "$?" = "0" || error "Error building rar"
}

install_phalcon () {
    ${GIT_BIN} clone --depth=1 git://github.com/phalcon/cphalcon.git
    cd cphalcon/build
    PATH=${PREFIX}/bin:$PATH ./install
    test "$?" = "0" || error "Error building cphalcon"
}

install_pear_modules () {
    for mod in Archive_Tar Auth Auth_HTTP Auth_SASL Benchmark Cache Cache_Lite Config Date DB DB_DataObject DB_DataObject_FormBuilder File HTML_Common HTML_Form HTML_QuickForm HTML_QuickForm_Controller HTML_Table HTML_Template_Flexy HTML_Template_IT HTML_Template_Sigma HTML_TreeMenu HTTP HTTP_Client HTTP_Download HTTP_Header HTTP_Request HTTP_Upload Image_Canvas Image_Color Image_Graph Log Mail Mail_Mime Mail_mimeDecode MDB MDB2 MDB2_Driver_mysql MIME_Type Net_DNS Net_FTP Net_IMAP Net_IPv4 Net_IPv6 Net_Ping Net_POP3 Net_SMTP Net_Socket Net_URL2 Net_URL Net_UserAgent_Detect Numbers_Roman Numbers_Words OLE Pager PHP_Compat PhpDocumentor PHPUnit Services_Weather SOAP Spreadsheet_Excel_Writer Structures_Graph Text_Password Validate XML_Beautifier XML_Parser XML_RPC XML_Serializer XML_Tree XML_Util mdb;
    do
        ${PREFIX}/bin/pear install $mod
    done
}

install_dbase () {
    PATH=${PREFIX}/bin:$PATH ${PREFIX}/bin/pecl install dbase
}

install_extensions () {
    install_imagick
    install_rar
    if [ "${SYSTEM_NAME}" = "Linux" ]; then
        install_geoip
        # install_phalcon
    fi
    install_dbase
    note "Proceeding with pear modules"
    install_pear_modules
    ${CP_BIN} -v ${PREFIX}/lib/php/extensions/no-debug*/* ${PREFIX}/lib/php/extensions
}

# additional: libmhash
