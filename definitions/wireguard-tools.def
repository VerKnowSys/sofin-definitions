DEF_FULL_NAME="Wireguard Tools"
DEF_STANDALONE=YES
DEF_NAME="wireguard-tools"
DEF_VERSION="1.0.20200513"
DEF_SHA="cb4317b4929274fdefb3360a5eeb54e5cdf4864c"
DEF_ORIGIN="https://git.zx2c4.com/${DEF_NAME}/snapshot/${DEF_NAME}-${DEF_VERSION}.tar.xz"
DEF_SOURCE_PATH="${MAIN_SOURCE_REPOSITORY}${DEF_NAME}-${DEF_VERSION}.tar.xz"
DEF_CONFIGURE_METHOD="no-conf"
DEF_BUILD_DIR_SUFFIX="src/"
DEF_REQUIREMENTS="bash"
DEF_USEFUL="bin/bash"
DEF_EXPORTS="wg wg-quick"

DEF_AFTER_UNPACK_METHOD="patch_makefile"
patch_makefile () {
    ${SED_BIN} -i '' -e "s|^PREFIX.*\$|PREFIX=${PREFIX}|" Makefile
    ${SED_BIN} -i '' -e "s|RUNSTATEDIR \"/wireguard/\"|\"${SERVICE_DIR}\"|" ipc.c
}

DEF_AFTER_INSTALL_METHOD="install_wg_quick"
install_wg_quick () {
    debug "Patching wg-quickâ€¦"
    ${SED_BIN} -i '' -e "s|^CONFIG_SEARCH_PATHS.*\$|CONFIG_SEARCH_PATHS=${SERVICE_DIR}|; s|/usr/local/bin/bash|${PREFIX}/bin/bash|" wg-quick/*.bash

    case "${SYSTEM_NAME}" in
        FreeBSD)
            ${INSTALL_BIN} -v wg-quick/freebsd.bash "${PREFIX}/bin/wg-quick"
            ;;

        OpenBSD)
            ${INSTALL_BIN} -v wg-quick/openbsd.bash "${PREFIX}/bin/wg-quick"
            ;;

        Darwin)
            ${INSTALL_BIN} -v wg-quick/darwin.bash "${PREFIX}/bin/wg-quick"
            ;;

        Linux)
            ${INSTALL_BIN} -v wg-quick/linux.bash "${PREFIX}/bin/wg-quick"
            ;;
    esac
}
