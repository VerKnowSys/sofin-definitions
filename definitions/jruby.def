DEF_DISABLE_ON="Darwin Linux"
DEF_FULL_NAME="JRuby"
DEF_NAME="jruby"
DEF_SHA="2501e8fce104dc3918a60e613570124169fd4667"
DEF_VERSION="9.0.1.0"
DEF_SOURCE_PATH="${MAIN_SOURCE_REPOSITORY}${DEF_NAME}-bin-${DEF_VERSION}.tar.gz"
DEF_CONFIGURE="binary"
DEF_AFTER_UNPACK_METHOD="${CP_BIN} -fR ${BUILD_DIR}/${DEF_NAME}-${DEF_VERSION}/ ${PREFIX}"
DEF_REQUIREMENTS="openjdk8"
DEF_USEFUL="bin/jdb bin/jhat bin/jinfo bin/jmap bin/jar bin/jps bin/jarsigner bin/jrunscript bin/policytool bin/java bin/jstack bin/registervm bin/classpath bin/javac bin/jstat bin/rmic bin/javadoc bin/jstatd bin/rmid bin/javah bin/keytool bin/rmiregistry bin/javap bin/javavm jcmd"
DEF_EXPORTS="ast gem jgem irb jirb jruby jrubyc ri rdoc rake ruby bundle"
DEF_ORIGIN="http://jruby.org/download"
DEF_CONFLICTS_WITH="Rubinius Ruby Passenger"
DEF_AFTER_INSTALL_METHOD="create_jruby_script"
DEF_USELESS="demo sample samples src.zip THIRD_PARTY_* COPYING"

create_jruby_script () {
    cd ${PREFIX}/bin
    ${FETCH_BIN} https://raw.githubusercontent.com/jruby/jruby/master/bin/jruby.sh ${FETCH_OPTS}
    ${MV_BIN} -f jruby jruby.bash
    ${MV_BIN} jruby.sh jruby
    ${CHMOD_BIN} +x jruby

    # two little fixes for fbsd sh:
    ${SED_BIN} -i '' -e 's/\[\[/[/g;s/\]\]/]/g' jruby
    ${SED_BIN} -i '' -e '26,39d' jruby

    # set JRE and JRUBY HOME:
    ${SED_BIN} -i '' -e "s#PRG=\$0#export JAVA_HOME=${PREFIX}/jre; export JRUBY_HOME=${PREFIX} ; PRG=\$0#"  jruby

    # build and install nailgun:
    cd ${PREFIX}/tool/nailgun
    ./configure
    make

    # make some post install magic:
    ${FIND_BIN} ${PREFIX} -type f -name '*.dll' -o -name '*.exe' -o -name '*.bat' | ${XARGS_BIN} rm
    ${LN_BIN} -s ${PREFIX}/bin/jruby ${PREFIX}/bin/ruby
    test ! -f ${HOME}/.gemrc && ${PRINTF_BIN} 'gem: --no-ri --no-rdoc' > ${HOME}/.gemrc
    gem install bundler
}
