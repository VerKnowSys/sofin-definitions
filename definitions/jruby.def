DEF_DISABLE_ON="Darwin Linux"
DEF_STANDALONE=YES
DEF_FULL_NAME="JRuby - Ruby implementation in Java (MRI v2.5.x compliant)"
DEF_NAME="jruby"
DEF_VERSION="9.2.5.0"
DEF_SHA="c78526ce98b1b4273d11989246cb9bf224ce9712"
DEF_SOURCE_PATH="${MAIN_SOURCE_REPOSITORY}${DEF_NAME}-dist-${DEF_VERSION}-bin.tar.gz"
DEF_ORIGIN="https://www.jruby.org/download"
DEF_CONFIGURE_METHOD="binary"
DEF_AFTER_UNPACK_METHOD="${CP_BIN} -fR ${BUILD_DIR}/${DEF_NAME}-${DEF_VERSION}/ ${PREFIX}"
DEF_REQUIREMENTS="openjdk8 bash"
DEF_USEFUL="bin/j* bin/bash"
DEF_EXPORTS="ast gem jgem irb jirb jruby ruby jrubyc ri rdoc rake bundle"
DEF_ORIGIN="http://jruby.org/download"
DEF_CONFLICTS_WITH="Ruby"
DEF_USELESS="lib/*.dll bin/*.exe bin/*.bat demo sample samples src.zip COPYING NOTICE.txt include THIRD_PARTY_README"

DEF_NO_MPROTECT=YES
DEF_NO_PAGEEXEC=YES
DEF_APPLY_LOWER_SECURITY_ON="java javac javap jar"

DEF_AFTER_INSTALL_METHOD="create_jruby_script"
create_jruby_script () {
    cd "${PREFIX}/bin"
    ${SED_BIN} -i '' -e "s#cygwin=false#export JAVA_HOME=${PREFIX}; export JRUBY_HOME=${PREFIX} ; cygwin=false#;"  "${PREFIX}/bin/jruby"
    for _exp_scrpt in $(to_iter "${DEF_EXPORTS}"); do
        # bash:
        ${SED_BIN} -i '' -e \
            "s#/usr/bin/env bash#${PREFIX}/bin/bash#g;" \
            "${PREFIX}/bin/${_exp_scrpt}"
        # jruby:
        ${SED_BIN} -i '' -e \
            "s#/usr/bin/env jruby#${PREFIX}/bin/jruby#g;" \
            "${PREFIX}/bin/${_exp_scrpt}"
    done

    # build and install nailgun:
    cd "${PREFIX}/tool/nailgun"
    try "./configure && make >> ${LOG}-${DEF_NAME}${DEF_SUFFIX} 2>> ${LOG}-${DEF_NAME}${DEF_SUFFIX}"

    # make some post install magic:
    try "${LN_BIN} -fs ${PREFIX}/bin/jruby ${PREFIX}/bin/ruby"
    if [ -f "${HOME}/.gemrc" ]; then
        printf 'gem: --no-ri --no-rdoc\n' > "${HOME}/.gemrc"
    fi

    try "gem install bundler >> ${LOG}-${DEF_NAME}${DEF_SUFFIX} 2>> ${LOG}-${DEF_NAME}${DEF_SUFFIX}"
}
