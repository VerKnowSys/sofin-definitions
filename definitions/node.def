DEF_NAME="node"
DEF_VERSION="v8.11.1"
DEF_FULL_NAME="Node.js ${DEF_VERSION} LTS (VerKnowSys build)"
DEF_SHA="9144b4545885af5c806f7f68d814ffa6a8ed97bd"
DEF_SOURCE_PATH="${MAIN_SOURCE_REPOSITORY}${DEF_NAME}-${DEF_VERSION}.tar.gz"
DEF_ORIGIN="http://nodejs.org/download/"
DEF_REQUIREMENTS="pkgconf make gettext libtool c-ares lzo lz4 m4 expat pcre readline perl zip bison gmp mpfr libmpc isl binutils-gold gcc libffi openssl python27 nghttp2 icu libuv"
DEF_CONFIGURE_ARGS="--with-dtrace --tag=VerKnowSys \
--shared-openssl --shared-openssl-libpath=${PREFIX} --openssl-use-def-ca-store \
--shared-cares --shared-cares-libpath=${PREFIX} \
--shared-nghttp2 --shared-nghttp2-libpath=${PREFIX} \
--shared-zlib --shared-zlib-libpath=${PREFIX} \
--shared-libuv --shared-libuv-libpath=${PREFIX} \
--without-etw --without-perfctr --without-snapshot \
--with-intl=system-icu --without-inspector \
"
DEF_CONFLICTS_WITH="Node"
DEF_STANDALONE=YES
DEF_USEFUL="bin/npm* bin/node* bin/yar* bin/gyp* bin/g++ bin/gcc bin/c++ bin/ld* bin/as bin/nm bin/ar bin/pkgconf bin/*conf"
DEF_EXPORTS="node npm npx"
DEF_USELESS="*.a lib/perl* lib/python* include/python x86_64* etc sbin share/systemtap"
DEF_STRIP=LIB

# NOTE: override Sofin compiler setup:
unset DEF_COMPILER_FLAGS DEF_LINKER_FLAGS CFLAGS CXXFLAGS LDFLAGS

CFLAGS="-Wl,-rpath=${PREFIX}/lib,--enable-new-dtags -I${PREFIX}/include -I/usr/include -fPIE"
CXXFLAGS="${CFLAGS}"
LDFLAGS="-L${PREFIX}/lib -L/usr/lib -fPIE"

CC="gcc -w -O2 -fpermissive ${CFLAGS}"
CXX="g++ -w -O2 -fpermissive ${CFLAGS}"
CPP="c++"
LINK="clang++ -Wl,-rpath=${PREFIX}/lib,--enable-new-dtags ${LDFLAGS} -pie"
LD="${LINK}"

DEF_AFTER_CONFIGURE_METHOD="after_config"
after_config () {
    ${SED_BIN} "s#/usr/local#${PREFIX}#g" deps/v8/src/v8.gyp

    # yes, I know it's wrong ;) but Node is wrong and nobody cares :P
    if [ ! -f "${PREFIX}/lib/libstdc++.so" ]; then
        ${LN_BIN} -s "/usr/lib/libc++.so" "${PREFIX}/lib/libstdc++.so"
    fi
}
DEF_MAKE_METHOD="env CC.host=\"${CC}\" CXX.host=\"${CXX}\" LINK.host=\"${LINK}\" LINK.target=\"${LINK}\" make ${MAKE_OPTS}"
DEF_INSTALL_METHOD="env CC.host=\"${CC}\" CXX.host=\"${CXX}\" LINK.host=\"${LINK}\" LINK.target=\"${LINK}\" make ${MAKE_OPTS} install"

DEF_AFTER_EXPORT_METHOD="after_exports"
after_exports () {
    npm config set cafile="${SERVICE_DIR}/etc/ssl/cert.pem"
    npm set prefix="${SERVICE_DIR}"
}
