DEF_FULL_NAME="NodeJS - asynchronous event driven JavaScript runtime"
DEF_NAME="node"
DEF_VERSION="7.4.0"
DEF_SHA="55edffc3aab410b5ff6ed1a7bd5d5991edbb669a"
DEF_SOURCE_PATH="${MAIN_SOURCE_REPOSITORY}${DEF_NAME}-v${DEF_VERSION}.tar.gz"
DEF_ORIGIN="http://nodejs.org/download/"
DEF_REQUIREMENTS="pkgconf ccache m4 make libressl python27 libedit xz zip pcre gdbm db sqlite yaml ninja bash"
DEF_CONFIGURE_ARGS="--tag=ServeD --with-dtrace --shared-openssl --without-npm --dest-cpu=x64 --ninja"

case "${SYSTEM_NAME}" in
    Darwin)
        DEF_CONFIGURE_ARGS="${DEF_CONFIGURE_ARGS} --dest-os=mac"
        DEF_STRIP=LIBS # required to NOT strip _node_module_register from node binary. It will cause brunch crashes on OSX 10.10/10.11.
        ;;

    FreeBSD)
        # DEF_LINKER_ARGS="${DEF_LINKER_ARGS} -lc++ -lcxxrt"
        DEF_CONFIGURE_ARGS="${DEF_CONFIGURE_ARGS} --dest-os=freebsd"
        ;;
esac
DEF_MAKE_METHOD="LINK=clang++ make -s ${MAKE_OPTS}"
DEF_TEST_METHOD=":"
DEF_INSTALL_METHOD="LINK=clang++ make -s install"
DEF_USEFUL="bin/bash bin/node* bin/*zip* bin/xz bin/ninja bin/bash bin/make bin/*ssl*"
DEF_EXPORTS="node yarn node-waf node-gyp coffee lessc uglifyjs cake"
DEF_CONFLICTS_WITH="Node"
DEF_NO_FAST_MATH=YES
# DEF_NO_TRAP_INT_OVERFLOW=YES

DEF_AFTER_INSTALL_METHOD="install_global_modules"
install_global_modules () {
    _yarn_ver_str="v0.20.0-20170126.2327"
    ${FETCH_BIN} -o ./yarn-${_yarn_ver_str}.tar.gz ${MAIN_SOURCE_REPOSITORY}yarn-${_yarn_ver_str}.tar.gz

    # NOTE: # package has "dist/" path as root prefix. it's component to strip:
    ${TAR_BIN} xf yarn-${_yarn_ver_str}.tar.gz --directory "${PREFIX}" --strip-components 1

    for mod in "coffee-script" "less" "uglify-js"; do
        note "Installing: $(distn "${mod}")"
        ${PREFIX}/bin/yarn global add ${mod}
    done
    return 0 # Node throws "npm ERR! code -2147483648" on success ;)
}
