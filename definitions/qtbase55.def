APP_FULL_NAME="Qt 5.5 Base Library"
APP_NAME="qtbase"
APP_POSTFIX="55"
APP_SHA="0b651543fa013ae151b7a11f0d0dee092050aa3f"
APP_VERSION="5.5.1"
APP_HTTP_PATH="${MAIN_SOURCE_REPOSITORY}qtbase-opensource-src-${APP_VERSION}.tar.xz"
APP_CONFIGURE_ARGS="-prefix ${PREFIX} -no-pch -c++11 -opensource -confirm-license -release -shared -no-sql-sqlite -no-xcb -nomake examples -nomake tests -L${PREFIX}/lib -no-qpa-platform-guard -continue -no-rpath"
APP_EXPORTS="moc lconvert lrelease lupdate qdoc3 qmake rcc uic qtpaths qtdiag qdoc macdeployqt macchangeqt qlalr qcollectiongenerator qhelpconverter qhelpgenerator qlalr qml1plugindump qmlbundle qmlimportscanner qmlmin qmlplugindump qmlprofiler qmlscene qmltestrunner"
APP_CONFLICTS_WITH="Qt Qt55 Qt55 Qtws55 Qtwk55 Qtme55"
APP_REQUIREMENTS="pkgconf gmake"
APP_MAKE_METHOD="gmake -s ${MAKE_OPTS}"
APP_COMPILER_ARGS="-D__BSD_VISIBLE"
APP_INSTALL_METHOD="gmake install -s"

if [ "${SYSTEM_NAME}" = "FreeBSD" ]; then
    create_freebsd_clang_spec () {
        ${CP_BIN} ../freebsd-g++46/* ./
        ${SED_BIN} -i '' -e 's/gcc46/clang/g' qmake.conf
        ${SED_BIN} -i '' -e 's/g++46/clang++/g' qmake.conf
        ${SED_BIN} -i '' -e 's/QMAKE_LIBS *=.*$/QMAKE_LIBS = -lutil -lexecinfo/g' qmake.conf
        ${SED_BIN} -i '' -e 's/-pthread/-pthread -lutil -lexecinfo/g' qmake.conf
        ${SED_BIN} -i '' -e "s#/usr/local#${PREFIX}#g" qmake.conf
    }

    create_freebsd_clang_spec_on_sources () {
        pd=$(pwd)
        ${SED_BIN} -i '' -e 's#PLATFORM=freebsd-g++#PLATFORM=freebsd-clang#g' ./configure
        ${SED_BIN} -i '' -e 's/gethostname$/\
#include <libutil.h>/g' src/corelib/io/qlockfile_unix.cpp

        # create mkspec for fbsd clang!
        if [ ! -d "mkspecs/freebsd-clang" ]; then
            ${MKDIR_BIN} -p mkspecs/freebsd-clang
            cd mkspecs/freebsd-clang/
            create_freebsd_clang_spec
        fi
        cd ${pd}
    }

    create_dest_freebsd_clang_spec () {
        # add freebsd-clang spec:
        if [ ! -d "${PREFIX}/mkspecs/freebsd-clang" ]; then
            ${MKDIR_BIN} -p ${PREFIX}/mkspecs/freebsd-clang
            cd ${PREFIX}/mkspecs/freebsd-clang/
            create_freebsd_clang_spec
        fi
    }
    APP_AFTER_UNPACK_CALLBACK="create_freebsd_clang_spec_on_sources"
    APP_AFTER_INSTALL_CALLBACK="create_dest_freebsd_clang_spec"
fi

if [ "${SYSTEM_NAME}" = "Darwin" ]; then
    makeSymlinks () {
        for lib in QtCore QtGui QtWidgets QtOpenGL; do
            ln -s "../lib/${lib}.framework/Headers" "${PREFIX}/include/${lib}"
        done
    }
    APP_AFTER_INSTALL_CALLBACK="makeSymlinks"
fi
