DEF_DISABLE_ON="FreeBSD"
DEF_FULL_NAME="Glassgow Haskell Compiler"
DEF_SHA="06b1d15aa87a5600165e6988c24fc186bf801f5e"
DEF_NAME="ghc"
DEF_VERSION="7.8.4"
DEF_SOURCE_PATH="${MAIN_SOURCE_REPOSITORY}${DEF_NAME}-${DEF_VERSION}-src.tar.xz"
DEF_REQUIREMENTS="perl m4 autoconf libtool automake gmp make python27 llvm"
DEF_EXPORTS="ghc ghc-${DEF_VERSION} ghci ghci-${DEF_VERSION} ghc-pkg ghc-pkg-${DEF_VERSION} runghc runghc-${DEF_VERSION} runhaskell ghcrun haddock haddock-ghc-${DEF_VERSION} cabal happy json2yaml yaml2json haskell-docs cpphs HsColour hpc hsc2hs opt aeson-pretty hlint ghc-mod ghc-modi"
DEF_MAKE_METHOD="/usr/bin/perl ./boot && make ${MAKE_OPTS}"
DEF_INSTALL_METHOD="make -s install"
DEF_CONFIGURE_ARGS="--with-clang=/usr/bin/clang --with-ghc=/Software/Ghc-bs/bin/ghc"
DEF_NO_CCACHE="YES"
DEF_CONFLICTS_WITH="Ghc-bs"

DEF_AFTER_UNPACK_METHOD="prepare_build"
prepare_build () {
    if [ "${SYSTEM_NAME}" = "FreeBSD" ]; then
        # on *BSD set it on fast build machine (https://ghc.haskell.org/trac/ghc/wiki/Building/Troubleshooting#Makehasrestarteditself3timesisthereamakefilebug):
        sysctl vfs.timestamp_precision=2
        # Fix for issue with no support for "-finline-limit=2500" option:
        ${SED_BIN} -i '' -e 's/rts\/sm\/Compact_CC_OPTS.*//' rts/ghc.mk
    fi
    ${CP_BIN} mk/build.mk.sample mk/build.mk
    ${SED_BIN} -i '' -e 's/#BuildFlavour = perf$/BuildFlavour = perf/' mk/build.mk
}

DEF_AFTER_INSTALL_METHOD="after_build"
after_build () {
    cabal_version="1.22.0.0"
    cabal_install="cabal-install-${cabal_version}.tar.gz"
    ${FETCH_BIN} ${MAIN_SOURCE_REPOSITORY}${cabal_install} ${FETCH_OPTS}
    tar xf ${cabal_install}
    cd cabal-install-${cabal_version}
    ${SED_BIN} -i '' -e 's#SCOPE_OF_INSTALLATION="${SCOPE_OF_INSTALLATION:---user}"#SCOPE_OF_INSTALLATION="${SCOPE_OF_INSTALLATION:---global}"#' ./bootstrap.sh
    note "Installing cabal"
    PATH=${PREFIX}/bin:/bin:/usr/bin PREFIX=${PREFIX} ./bootstrap.sh
    ${PREFIX}/bin/cabal install happy ghc-mod hlint haskell-docs --prefix=${PREFIX} --reinstall --force-reinstalls -j6
}

# TIps and tricks:
# 0. Use "cabal install XXXXX --prefix=/Software/Ghc".
# 1. Use "cabal install hdocs --extra-lib-dirs=/usr/lib" if you see iconv linking problems on OSX
# 2.
