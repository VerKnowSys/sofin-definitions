APP_FULL_NAME="Glassgow Haskell Compiler"
APP_SHA="06b1d15aa87a5600165e6988c24fc186bf801f5e"
APP_NAME="ghc"
APP_VERSION="7.8.4"
APP_HTTP_PATH="${MAIN_SOURCE_REPOSITORY}${APP_NAME}-${APP_VERSION}-src.tar.xz"
APP_REQUIREMENTS="perl m4 autoconf libtool automake gmp51 gmake python27 llvm"
APP_EXPORTS="ghc ghci ghc-pkg runhaskell ghcrun haddock cabal happy json2yaml yaml2json haskell-docs cpphs HsColour hpc  hsc2hs opt aeson-pretty hlint ghc-mod ghc-modi"
APP_MAKE_METHOD="/usr/bin/perl ./boot && gmake -s ${MAKE_OPTS}"
APP_INSTALL_METHOD="gmake install"
APP_CONFIGURE_ARGS="--with-clang=/usr/bin/clang --with-ghc=/Software/Ghc-bs/bin/ghc"
APP_NO_CCACHE="YES"
APP_CONFLICTS_WITH="Ghc-bs"

APP_AFTER_UNPACK_CALLBACK="prepare_build"
prepare_build () {
    if [ "${SYSTEM_NAME}" = "FreeBSD" ]; then
        # on *BSD set it on fast build machine (https://ghc.haskell.org/trac/ghc/wiki/Building/Troubleshooting#Makehasrestarteditself3timesisthereamakefilebug):
        sysctl vfs.timestamp_precision=2
        # Fix for issue with no support for "-finline-limit=2500" option:
        ${SED_BIN} -i '' -e 's/rts\/sm\/Compact_CC_OPTS.*//' rts/ghc.mk
    fi
    ${CP_BIN} mk/build.mk.sample mk/build.mk
    ${SED_BIN} -i '' -e 's/#BuildFlavour = perf$/BuildFlavour = perf/' mk/build.mk
}

APP_AFTER_INSTALL_CALLBACK="after_build"
after_build () {
    cabal_version="1.22.0.0"
    cabal_install="cabal-install-${cabal_version}.tar.gz"
    ${FETCH_BIN} ${MAIN_SOURCE_REPOSITORY}${cabal_install}
    tar xf ${cabal_install}
    cd cabal-install-${cabal_version}
    ${SED_BIN} -i '' -e 's#SCOPE_OF_INSTALLATION="${SCOPE_OF_INSTALLATION:---user}"#SCOPE_OF_INSTALLATION="${SCOPE_OF_INSTALLATION:---global}"#' ./bootstrap.sh
    note "Installing cabal"
    PATH=${PREFIX}/bin:/bin:/usr/bin PREFIX=${PREFIX} ./bootstrap.sh
    ${PREFIX}/bin/cabal install happy ghc-mod hlint haskell-docs --prefix=${PREFIX} --reinstall --force-reinstalls -j6
}

# TIps and tricks:
# 0. Use "cabal install XXXXX --prefix=/Software/Ghc".
# 1. Use "cabal install hdocs --extra-lib-dirs=/usr/lib" if you see iconv linking problems on OSX
# 2.
