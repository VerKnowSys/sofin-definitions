DEF_FULL_NAME="MariaDB 10.1"
DEF_STANDALONE=YES
DEF_NAME="mariadb"
DEF_VERSION="10.1.47"
DEF_SHA="25d25d18a7fa5779b5b74d6d56c947e6a527362b"
DEF_ORIGIN="http://ftp.icm.edu.pl/pub/unix/database/${DEF_NAME}//${DEF_NAME}-${DEF_VERSION}/source/${DEF_NAME}-${DEF_VERSION}.tar.gz"
DEF_SOURCE_PATH="${MAIN_SOURCE_REPOSITORY}${DEF_NAME}-${DEF_VERSION}.tar.gz"
DEF_REQUIREMENTS="pcre libressl libsodium libxml2 libevent snappy"
DEF_CONFIGURE_METHOD="cmake"
DEF_CONFIGURE_ARGS="-DBUILD_CONFIG=mysql_release -DINSTALL_INCLUDEDIR=include/mysql -DINSTALL_INFODIR=share/info -DINSTALL_MYSQLSHAREDIR=share/mysql -DMYSQL_MAINTAINER_MODE=OFF -DINSTALL_SCRIPTDIR=bin -DDEFAULT_CHARSET=utf8 -DDEFAULT_COLLATION=utf8_general_ci -DENABLED_LOCAL_INFILE=ON -DENABLE_DEBUG_SYNC=OFF -DWITH_SAFEMALLOC=OFF -DWITH_UNIT_TESTS=OFF -DWITH_VALGRIND=OFF -DWITH_LIBWRAP=OFF -DWITH_INNODB_LZ4=YES -DGRN_WITH_LZ4=YES -DWITH_INNODB_BZIP2=YES -DWITH_INNODB_LZMA=YES -DWITH_INNODB_LZO=YES -DINSTALL_SYSCONFDIR=${SERVICE_DIR}/etc -DTMPDIR=/tmp -DMYSQL_DATADIR=${SERVICE_DIR}/data -DWITH_SSL=yes -DWITH_INNODB_DISALLOW_WRITES=ON -DENABLED_PROFILING=OFF -DCOMPILATION_COMMENT=VerKnowSys -DPLUGIN_MROONGA=NO -DPLUGIN_TOKUDB=YES -DPLUGIN_DAEMON_EXAMPLE=NO -DCMAKE_OSX_ARCHITECTURES=x86_64 -DHAVE_STDCXX11=YES -DWITH_EMBEDDED_SERVER=ON -DPLUGIN_SEQUENCE=YES -DPLUGIN_PERFSCHEMA=YES -DPLUGIN_PARTITION=YES -DPLUGIN_FEEDBACK=YES -DPLUGIN_ARIA=YES -DPLUGIN_AUTH_GSSAPI_CLIENT=NO -DCMAKE_SKIP_BUILD_RPATH=YES -DWITHOUT_EXAMPLE_STORAGE_ENGINE=1 -DWITH_JEMALLOC=YES -DWITH_PCRE=system -DWITH_ZLIB=system -DWITH_INNODB_SNAPPY=YES -DPLUGIN_XTRADB=YES -DSECURITY_HARDENED=ON"
DEF_EXPORTS="mysql mysqld_multi mysqld mysqld_safe mysql_config mysqladmin mysqlimport mysqlbinlog mysqldump mysqlaccess mysqlcheck mysqlhotcopy mysql_upgrade mysql_install_db msql2mysql myisamchk myisamlog myisampack mysqltest mysqlslap mysqldumpslow mysqlbug mysql_zap mysql_waitpid mysql_tzinfo_to_sql mysql_setpermission mysql_secure_installation mysql_plugin mysql_fix_extensions mysql_find_rows mysql_convert_table_format mysql_client_test my_print_defaults myisam_ftdump innochecksum aria_chk aria_dump_log aria_ftdump aria_pack aria_read_log mytop perror mysqlshow mysql-proxy resolveip mariabackup tokuft_logprint tokuftdump"
DEF_USELESS="share/{bison,gdb,libtool,cmake,man,gettext,aclocal,pkgconfig} share/gtk* share/glib* share/gettext* doc sql-bench data man docs sql-bench INSTALL-BINARY README COPYING COPYING.LESSER COPYING.thirdparty CREDITS EXCEPTIONS-CLIENT README-wsrep scripts libexec mysql-test include libdata lib/{cmake,pkgconfig} lib/*.{a,la,sh}"
DEF_USEFUL="bin/my*" # always be prepared for more ;)

DEF_CONFLICTS_WITH="Mysql Mariadb104"
DEF_AFTER_UNPACK_METHOD="patch_the_patch"
patch_the_patch () {
    ${SED_BIN} -i '' -e "s|%%LOCALBASE%%|${PREFIX}|g" "${HOME}/.sofin/definitions/definitions/patches/mariadb/FreeBSD/patch-storage_tokudb_PerconaFT_cmake__modules_TokuThirdParty.cmake" 2>/dev/null
    return 0
}

DEF_AFTER_PATCH_METHOD="sed_stuff; reset_patch_state"
sed_stuff () {
    ${SED_BIN} -i '' -e "s|%%LOCALBASE%%|${PREFIX}|g" scripts/mysql_config.sh
    ${SED_BIN} -i '' -e "s|%%PREFIX%%|${PREFIX}|g" mysys/my_default.c
    return 0
}
reset_patch_state () {
    _cwd="$(${PWD_BIN} 2>/dev/null)"
    cd "${DEFINITIONS_DIR}"
    ${GIT_BIN} checkout -- "patches/mariadb/FreeBSD/patch-storage_tokudb_PerconaFT_cmake__modules_TokuThirdParty.cmake"
    cd "${_cwd}"
}

DEF_AFTER_INSTALL_METHOD="strip_libexec"
strip_libexec () {
    ${STRIP_BIN} lib/plugin/*.so 2>/dev/null
    return 0
}

DEF_AFTER_BUILD_METHOD="make_sure_data_dir_exists_or_create_it"
make_sure_data_dir_exists_or_create_it () {
    for _dir in etc tmp data var/log; do
        try "${MKDIR_BIN} -p ${SERVICE_DIR}/${_dir}"
    done
}

case "${SYSTEM_NAME}-${SYSTEM_VERSION}" in
    FreeBSD-11*)
        unset DEF_USE_LTO
        ;;
esac
