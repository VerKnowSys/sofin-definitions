DEF_NAME="curl"
DEF_VERSION="7.61.1"
DEF_SHA="8b56123714b4e061f0f71005c5be598b12f82483"
DEF_ORIGIN="https://github.com/curl/curl/releases"
DEF_SOURCE_PATH="${MAIN_SOURCE_REPOSITORY}${DEF_NAME}-${DEF_VERSION}.tar.xz"
DEF_EXPORTS="curl curl-config"
DEF_REQUIREMENTS="pkgconf make libunistring gettext lzo libffi libxml2 libressl perl libidn2 libevent jemalloc nghttp2 libssh2 python27"
DEF_CONFIGURE_ARGS="--with-ca-bundle=${SERVICE_DIR}/etc/ssl/cert.pem --disable-debug --with-libidn2=${PREFIX} --with-nghttp2=${PREFIX} --with-libssh2=${PREFIX} --without-gnutls --without-polarssl --without-mbedtls --without-cyassl --without-nss --without-axtls --disable-ldap --disable-ldaps"
DEF_INSTALL_METHOD="make -s install"
DEF_AFTER_INSTALL_METHOD="after_installation"
DEF_STANDALONE=YES
after_installation () {
    run "${MKDIR_BIN} -p ${SERVICE_DIR}/etc/ssl"
    run "${RM_BIN} -vf ${SERVICE_DIR}/etc/ssl/cert.pem"
    run "${FETCH_BIN} -o ${SERVICE_DIR}/etc/ssl/cert.pem ${FETCH_OPTS} ${MAIN_SOURCE_REPOSITORY}cacert.pem"
}
DEF_USELESS="lib/*python* include/*python* lib/*perl* include/*perl* share/man share/texinfo share/info share/aclocal"
DEF_USE_SAFE_STACK=YES

DEF_AFTER_INSTALL_METHOD="fetch_and_install_fresh_ca_cert"
fetch_and_install_fresh_ca_cert () {
    mkdir -p "${SERVICE_DIR}/etc/ssl"

    try "${MKDIR_BIN} -p ${SERVICE_DIR}/etc/ssl; ${RM_BIN} -vf ${SERVICE_DIR}/etc/ssl/cert.pem" \
        && note "Removed old CA cert: $(distn "${SERVICE_DIR}/etc/ssl/cert.pem")"

    try "${FETCH_BIN} -o ${SERVICE_DIR}/etc/ssl/cert.pem ${FETCH_OPTS} ${DEF_DEFAULT_CA_CERT_SOURCE}" \
        && note "Fetched most recent CA certs from: $(distn "${DEF_DEFAULT_CA_CERT_SOURCE}")" \
        && return 0

    run "${FETCH_BIN} -o ${SERVICE_DIR}/etc/ssl/cert.pem ${FETCH_OPTS} ${DEF_DEFAULT_CA_CERT_SOURCE_ALT}" \
        && note "Fetched cached CA certs from: $(distn "${DEF_DEFAULT_CA_CERT_SOURCE_ALT}")" \
        && return 0
}
