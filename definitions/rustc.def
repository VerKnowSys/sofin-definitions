DEF_FULL_NAME="Rustc - Rust-lang compiler"
DEF_SHA="e496d028fee5df7e38d40ac5f572cee9264f7277"
DEF_NAME="rustc"
DEF_VERSION="1.12.0"
DEF_SOURCE_PATH="${MAIN_SOURCE_REPOSITORY}${DEF_NAME}-${DEF_VERSION}-src.tar.gz"
DEF_REQUIREMENTS="pkgconf make m4 ccache libedit bzip2 yaml lzma xz pcre gettext perl texinfo libidn gmp expat gdbm db sqlite re2c python27 ninja cmake unixodbc libressl libssh2 libevent spdylay nghttp2 curl llnextgen llvm libunwind" # jemalloc libgit2     libgpg-error libgcrypt          libxml2 libxslt
DEF_CONFIGURE_ARGS="--release-channel=stable --enable-clang --enable-ninja --enable-orbit --enable-jemalloc --default-linker=/usr/bin/clang --default-ar=${PREFIX}/bin/llvm-ar --enable-ccache --llvm-root=${PREFIX} --datadir=${PREFIX}/share --infodir=${PREFIX}/share/info --mandir=${PREFIX}/share/man --disable-valgrind --disable-valgrind-rpass --disable-docs --disable-codegen-tests --target=x86_64-unknown-$(lowercase "${SYSTEM_NAME}") --enable-optimize --enable-optimize-cxx --enable-optimize-llvm"
DEFAULT_RUSTFLAGS="" # -Ccodegen-units=${CPUS}-Cinline-threshold=269"
DEF_MAKE_METHOD="makeit"
makeit () {
    run "RUSTFLAGS=\"${DEFAULT_RUSTFLAGS}\" NO_REBUILD=0 VERBOSE=1 ${PREFIX}/bin/make -j${CPUS}"
}
DEF_INSTALL_METHOD="installit"
installit () {
    run "RUSTFLAGS=\"${DEFAULT_RUSTFLAGS}\" NO_REBUILD=1 VERBOSE=0 make install"
}
DEF_USEFUL="bin/rust* bin/*conf* bin/*.*sh bin/*cfg bin/*make bin/gettext* bin/libtool* bin/llvm* bin/*cache"
DEF_EXPORTS="rustc rustdoc rust-lldb rust-gdb"
DEF_USELESS="docs doc man include/python* lib/python* share/au* share/bison share/ac* share/info share/*doc include/perl* lib/*perl* share/common-lisp share/emacs share/examples share/git-core share/texinfo share/libxslt-plugins etc"
DEF_CONFLICTS_WITH="Rustc"
DEF_LINKER_ARGS="-L${PREFIX}/lib -L/usr/lib -lc++"
DEF_NO_CCACHE=YES # it's used internally anyway, but controlled by Rust build system

DEF_AFTER_PATCH_METHOD="sed_fixes"
sed_fixes () {
    # ${SED_BIN} -i '' -e "s|-g||g" mk/cfg/x86_64-unknown-freebsd.mk
    ${SED_BIN} -i '' -e "s|stdc++|c++|g" configure
    ${SED_BIN} -i '' -e "s|/usr/local|${PREFIX}|g" mk/cfg/x86_64-unknown-freebsd.mk src/rt/hoedown/Makefile src/jemalloc/configure src/jemalloc/configure.ac configure src/rust-installer/install-template.sh
    ${SED_BIN} -i '' -e "s|%%LOCALBASE%%|${PREFIX}|g" mk/main.mk
    return 0
}

if [ "Darwin" = "${SYSTEM_NAME}" ]; then
    DEF_CONFIGURE_ARGS="${DEF_CONFIGURE_ARGS} --disable-rpath --enable-rustbuild"
else # for non Darwin, use python from PREFIX:
    DEF_CONFIGURE_ARGS="${DEF_CONFIGURE_ARGS} --python=${PREFIX}/bin/python --enable-rpath --disable-rustbuild"
fi
