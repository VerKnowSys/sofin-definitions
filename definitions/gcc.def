DEF_DISABLE_ON="Linux Darwin"
langs="c,c++,objc,fortran"
DEF_FULL_NAME="GNU Compiler 5.4 (with langs: ${langs})"
DEF_VERSION="5.4.0"
DEF_NAME="gcc"
DEF_SHA="07524df2b4ab9070bad9c49ab668da72237b8115"
DEF_HTTP_PATH="${MAIN_SOURCE_REPOSITORY}${DEF_NAME}-${DEF_VERSION}.tar.bz2"
DEF_CONFIGURE="../configure"

suffix="$(echo "${DEF_VERSION}" | ${CUT_BIN} -c1 2>/dev/null)"
targlib="${PREFIX}/lib"
libexec="${PREFIX}/libexec"
DEF_CONFIGURE_ARGS="--enable-gnu-indirect-function --disable-libgcj \
    --enable-libstdcxx --disable-multilib --disable-nls --with-system-zlib \
    --with-gmp=${PREFIX} --with-mpfr=${PREFIX} --with-mpc=${PREFIX} \
    --with-isl=${PREFIX} --with-gxx-include-dir=${targlib}/include/c++/ \
    --libexecdir=${libexec} --libdir=${targlib} --with-as=${PREFIX}/bin/as \
    --with-ld=/usr/bin/ld.gold --enable-gold=yes --enable-lto=yes \
    --disable-bootstrap --with-pkgversion=\"ServeD GCC build\" \
    --enable-languages=${langs} --disable-shared --enable-static \
"
# ^ we don't do shared build because each binary built with shared gcc compiler
# ^ will result with a dependency to libstdcxx from Gcc bundle..
DEF_REQUIREMENTS="pkgconf bzip2 make m4 perl gmp4 mpfr libmpc isl012 zip autoconf libtool automake bison gmp texinfo binutils-gold"

# We have to override CROSS_PLATFORM_COMPILER_FLAGS to disable stack protector.
# This feature requires Sofin 0.98.x to work:
CROSS_PLATFORM_COMPILER_FLAGS="-w -O2 -fPIC -fPIE -fno-strict-overflow -fno-stack-protector"
DEFAULT_COMPILER_FLAGS="${CROSS_PLATFORM_COMPILER_FLAGS} -Wl,-fuse-ld=gold"
DEF_LINKER_ARGS="-lssp"

common_opts="LANG=C LC_ALL=C SUFFIX=${suffix} GCC_VERSION=${DEF_VERSION} DISTVERSION=${DEF_VERSION}"
DEF_MAKE_METHOD="${common_opts} make -s ${MAKE_OPTS}"
DEF_INSTALL_METHOD="${common_opts} make -s install ${MAKE_OPTS}"
DEF_DEFAULT_USELESS="" # we do static build, hence we need to leave lib/*.a intact
DEF_USELESS="man doc docs share/doc share/info share/bison share/libtool share/texinfo lib/*perl* share/man/man7 share/aclocal* share/auto*"
DEF_USEFUL="bin/ld* bin/x86_64-unknown-freebsd*"
DEF_EXPORTS="aot-compile c++ cpp g++ gcc gcc-ar gcc-nm gcc-ranlib gcov gcov-tool gserialver gtnameserv jcf-dump jv-convert addr2line as ar dlltool gprof nlmconv nm objcopy objdump ranlib readelf size strings strip windmc windres gfortran dwp"
DEF_CONFLICTS_WITH="Binutils"

DEF_AFTER_UNPACK_CALLBACK="make_and_enter_builddir"
make_and_enter_builddir () {
    ${MKDIR_BIN} -p gcc-build
    cd gcc-build
}
DEF_AFTER_INSTALL_CALLBACK="strip_libexec_and_go_up"
strip_libexec_and_go_up () {
    for to_str in cc1 cc1obj cc1plus collect2 f951 lto1 lto-wrapper liblto_plugin.so.0; do
        ${STRIP_BIN} ${PREFIX}/libexec/gcc/x86_64-unknown-freebsd11.0/${DEF_VERSION}/${to_str}
    done
    cd ..
}
