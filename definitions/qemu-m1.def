DEF_DISABLE_ON="FreeBSD Linux"
DEF_FULL_NAME="QEMU is a generic and open source machine emulator and virtualizer. Build for arch: ARM64 (AARCH64) and X86_64 (AMD64)"
DEF_NAME="qemu"
DEF_VERSION="m1"
DEF_SHA="f97debb9c3b03bf6b03add6d0beb5700a044495e"
DEF_SOURCE_PATH="${MAIN_SOURCE_REPOSITORY}${DEF_NAME}-${DEF_VERSION}.tar.xz"
DEF_REQUIREMENTS="libtool @glib @curl-openssl capstone libusb libslirp libssh expat libzip lzop lz4 db sqlite libpcap libgpg-error pixman @gnutls userspace-rcu mpfr libmpc isl012 vde2 vdetelweb zlib bash snappy"
DEF_CONFIGURE_ARGS="--target-list=arm-softmmu,aarch64-softmmu,x86_64-softmmu --enable-gnutls --enable-nettle --enable-curl --enable-vnc --enable-libssh --enable-cocoa --enable-slirp --enable-capstone --enable-zstd --disable-werror --disable-docs --disable-gtk --disable-xen --disable-xen-pci-passthrough --extra-cflags=-DNCURSES_WIDECHAR=1 --disable-sdl"
DEF_CONFIGURE_METHOD="/bin/bash ./configure"
DEF_USEFUL="bin/qemu*"
DEF_USELESS="cmake share/gtk* share/ac* share/auto* share/{gettext-0.20,glib-2.0,bison,readline,libgpg-error,p11-kit,nghttp2,locale} share/read* include lib/*.a lib/*.sh lib/{glib-2.0,cmake,pkgconfig,gio,gettext,pkcs11,X11} share/{emacs,gdb,common-lisp,bash-completion} man libexec sbin docs"
DEF_EXPORTS="qemu-edid qemu-img qemu-nbd qemu-io qemu-system-aarch64 qemu-system-arm qemu-system-x86_64 qemu-system-aarch64-unsigned qemu-system-arm-unsigned qemu-system-x86_64-unsigned qemu-storage-daemon"
DEF_USE_SAFE_STACK=YES

DEF_AFTER_INSTALL_METHOD="name_tool_darwin"
name_tool_darwin () {
    for _bin in ${PREFIX}/bin/qemu*; do
        install_name_tool -add_rpath "${PREFIX}/lib" ${_bin}
    done
    return 0
}

DEF_AFTER_EXPORT_METHOD="sign_the_code"
sign_the_code () {
    note "Setting entitlements to allow Qemu to run HVF accelerationâ€¦"
    cat > /tmp/entitlements.xml <<EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>com.apple.security.hypervisor</key>
    <true/>
</dict>
</plist>
EOF
    try "codesign -s - --entitlements /tmp/entitlements.xml --force ${PREFIX}/bin/qemu-system-aarch64-unsigned"
    try "codesign -s - --entitlements /tmp/entitlements.xml --force ${PREFIX}/bin/qemu-system-arm-unsigned"
    try "codesign -s - --entitlements /tmp/entitlements.xml --force ${PREFIX}/bin/qemu-system-x86_64-unsigned"
    ${RM_BIN} -f /tmp/entitlements.xml
    return 0
}
