APP_FULL_NAME="Influxb database"
APP_NAME="influxdb"
APP_HTTP_PATH="git://github.com/OliverLetterer/dummy-repo.git"
APP_GIT_MODE="true"
APP_VERSION="0.10.0"
APP_GIT_CHECKOUT="v${APP_VERSION}"
APP_REQUIREMENTS="pkgconf pcre go15 protobuf"
APP_CONFIGURE_SCRIPT="ignore"
APP_MAKE_METHOD="make_action"
APP_INSTALL_METHOD="strip_and_install_links"
APP_USELESS="doc test include share src local/src misc pkg api etc man lib/python* AUTHORS CONTRIBUTING.md CONTRIBUTORS LICENSE PATENTS README.md VERSION favicon.ico robots.txt"
APP_EXPORTS="influx influx_stress influxd inspect test_client urlgen"

make_action () {
    srcdir="$(${PWD_BIN} 2>/dev/null)"
    influxdb_git_repo="https://github.com/influxdata/influxdb.git"
    export PATH=${PATH}:/Software/Git/exports
    export GOPATH=${PREFIX}/local
    debug "Cleaning GOPATH: ${GOPATH}"
    ${RM_BIN} -rf "${GOPATH}"
    ${MKDIR_BIN} -p ${GOPATH}/src/github.com/influxdata
    cd $GOPATH/src/github.com/influxdata && \
    debug "Cloning ${influxdb_git_repo}" && \
    ${GIT_BIN} clone ${influxdb_git_repo} && \
    cd $GOPATH/src/github.com/influxdata/influxdb && \
    debug "Checking out branch: v${APP_VERSION}" && \
    ${GIT_BIN} checkout -b "v${APP_VERSION}" && \
    debug "Getting ${APP_NAME}" && \
    ${PREFIX}/bin/go get -v -t ./... && \
    debug "Building ${APP_NAME}" && \
    ${PREFIX}/bin/go clean ./... && \
    debug "Installing ${APP_NAME}" && \
    ${PREFIX}/bin/go install ./... && \
    debug "Done."
}

strip_and_install_links () {
    debug "Stripping binaries from local prefix"
    for afile in $(${FIND_BIN} "${PREFIX}/local/bin" -type f); do
        debug "Stripping file: ${afile}: $(${STRIP_BIN} ${afile})"
    done
    for binary in influx influx_stress influxd inspect test_client urlgen; do
        ${LN_BIN} -s ${PREFIX}/local/bin/${binary} ${PREFIX}/bin/${binary}
    done
}
