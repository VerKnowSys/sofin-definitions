APP_FULL_NAME="Influxb database"
APP_NAME="influxdb"
APP_SHA="0298032e972da022ceb56a69d816e0c30c8eaddf"
APP_VERSION="0.9.6.1"
APP_HTTP_PATH="${MAIN_SOURCE_REPOSITORY}${APP_NAME}-v${APP_VERSION}.tar.gz"
APP_REQUIREMENTS="pkgconf pcre go protobuf"
APP_CONFIGURE_SCRIPT="ignore"
APP_MAKE_METHOD="make_action"
APP_INSTALL_METHOD="strip_and_install_links"
APP_USELESS="doc test include share src local/src misc pkg api"
APP_EXPORTS="influx influx_stress influxd inspect test_client urlgen"

make_action () {
    srcdir="$(${PWD_BIN} 2>/dev/null)"
    export PATH=${PATH}:/Software/Git/exports
    export GOPATH=${PREFIX}/local
    debug "Cleaning GOPATH: ${GOPATH}"
    ${RM_BIN} -rf "${GOPATH}"
    ${MKDIR_BIN} -p ${GOPATH}/src/github.com/influxdb
    cd $GOPATH/src/github.com/influxdb && \
    debug "Cloning https://github.com/influxdata/influxdb.git" && \
    ${GIT_BIN} clone https://github.com/influxdata/influxdb.git && \
    cd $GOPATH/src/github.com/influxdb/influxdb && \
    debug "Getting ${APP_NAME}" && \
    ${PREFIX}/bin/go get -u -f -t ./... && \
    debug "Checking out version: ${APP_VERSION}" && \
    ${GIT_BIN} checkout -b "v${APP_VERSION}" && \
    debug "Building ${APP_NAME}" && \
    ${PREFIX}/bin/go clean ./... && \
    debug "Installing ${APP_NAME}" && \
    ${PREFIX}/bin/go install ./... && \
    debug "Done."
}

strip_and_install_links () {
    debug "Stripping binaries from local prefix"
    for afile in $(${FIND_BIN} "${PREFIX}/local/bin" -type f); do
        debug "Stripping file: ${afile}: $(${STRIP_BIN} ${afile})"
    done
    for binary in influx influx_stress influxd inspect test_client urlgen; do
        ${LN_BIN} -s ${PREFIX}/local/bin/${binary} ${PREFIX}/bin/${binary}
    done
}
