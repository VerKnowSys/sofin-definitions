DEF_DISABLE_ON="Linux"
DEF_STANDALONE=YES
DEF_FULL_NAME="Redis is in-memory data structure store, used as database, cache and message broker."
DEF_NAME="redis"
DEF_SHA="a43c24ea6365482323b78e21752d610756efcc39"
DEF_VERSION="5.0.3"
DEF_ORIGIN="http://${DEF_NAME}.io"
DEF_SOURCE_PATH="${MAIN_SOURCE_REPOSITORY}${DEF_NAME}-${DEF_VERSION}.tar.gz"
DEF_REQUIREMENTS="jemalloc"
DEF_CONFIGURE_METHOD="ignore"
DEF_USELESS="lib/*.a include lib/pkgconfig man share"

DEF_MAKE_METHOD="build_and_install_redis"
build_and_install_redis () {
    _cwd="$(pwd 2>/dev/null)"
    cd deps/lua/src \
        && try "${CP_BIN} -vf fpconv.* lua_* strbuf.* '${_cwd}/src'"
    cd "${_cwd}"

    note "Installing prebuilt Jemalloc library from PREFIX: ${PREFIX}"
    try "${MKDIR_BIN} -p 'deps/jemalloc/lib/'"
    try "${INSTALL_BIN} '${PREFIX}/lib/libjemalloc.a' 'deps/jemalloc/lib/'"
    try "${INSTALL_BIN} '${PREFIX}/lib/libjemalloc_pic.a' 'deps/jemalloc/lib/'"
    try "${INSTALL_BIN} '${PREFIX}/lib/libjemalloc.so.2' 'deps/jemalloc/lib/'"
    try "${LN_BIN} -fs '${PREFIX}/lib/libjemalloc.so.2' '${PREFIX}/lib/libjemalloc.so'"
    try "\
        make \
            STD= \
            OPT= \
            DEBUG= \
            WARN= \
            V=yo \
            PREFIX='${PREFIX}' \
            CFLAGS='${CFLAGS} -fPIC -fPIE -Wl,-z,relro,-z,now,-rpath=${PREFIX}/lib,--enable-new-dtags,-pie -I${PREFIX}/include -I/usr/include' \
            LDFLAGS='${LDFLAGS} -pie -L${PREFIX}/lib -L/usr/lib -lexecinfo -lm -ljemalloc' \
            MALLOC=jemalloc \
                install \
    "
}
DEF_INSTALL_METHOD="true"
DEF_NO_CCACHE=YES
DEF_CONFLICTS_WITH="Redis"
DEF_NO_SSP_BUFFER_OVERRIDE=YES
DEF_NO_FORTIFY_SOURCE=YES
DEF_NO_TRAP_INT_OVERFLOW=YES
DEF_EXPORTS="${DEF_NAME}-cli ${DEF_NAME}-server ${DEF_NAME}-benchmark ${DEF_NAME}-check-dump ${DEF_NAME}-check-aof ${DEF_NAME}-server ${DEF_NAME}-sentinel"
if [ "${SYSTEM_NAME}" = "Darwin" ]; then
    # under Darwin "leaks" is used .... so this crap is calling sudo N times one by one,
    # causing flood of "ask for root password" prompts... I have no further comments...
    DEF_TEST_METHOD="false"
fi
DEF_STANDALONE=YES
unset DEF_USE_LTO
