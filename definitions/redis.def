DEF_DISABLE_ON="Linux"
DEF_STANDALONE=YES
DEF_FULL_NAME="Redis is in-memory data structure store, used as database, cache and message broker."
DEF_NAME="redis"
DEF_VERSION="4.0.10"
DEF_SHA="d2738d9b93a3220eecc83e89a7c28593b58e4909"
DEF_ORIGIN="http://${DEF_NAME}.io"
DEF_SOURCE_PATH="${MAIN_SOURCE_REPOSITORY}${DEF_NAME}-${DEF_VERSION}.tar.gz"
DEF_REQUIREMENTS="make libedit lua51 jemalloc"
DEF_CONFIGURE_METHOD="ignore"
DEF_MAKE_METHOD="build_and_install_redis"
build_and_install_redis () {
    _cwd="$(pwd)"
    cd deps/lua/src && ${CP_BIN} fpconv.* lua_* strbuf.* "${_cwd}/src"
    cd "${_cwd}"

    mkdir -p "deps/jemalloc/lib"
    ${CP_BIN} "${PREFIX}/lib/libjemalloc_pic.a" "deps/jemalloc/lib/"

    _adds="-lexecinfo"
    if [ "${SYSTEM_NAME}" = "Darwin" ]; then
        unset _adds
        ${CP_BIN} "${PREFIX}/lib/libjemalloc.a" "deps/jemalloc/lib/"
    fi

    PREV_FINAL_CFLAGS="${CFLAGS}" make STD= OPT= DEBUG= WARN= V=yo PREFIX="${PREFIX}" CFLAGS="${CFLAGS} -I${PREFIX}/include -I/usr/include -Wl,-E -pthread" LDFLAGS="${LDFLAGS} -L${PREFIX}/lib -L/usr/lib -lpthread -lm -lc ${_adds}" MALLOC=jemalloc install
}
DEF_INSTALL_METHOD="true"
DEF_NO_CCACHE=YES
DEF_CONFLICTS_WITH="Redis"
DEF_NO_SSP_BUFFER_OVERRIDE=YES
DEF_NO_FORTIFY_SOURCE=YES
DEF_NO_TRAP_INT_OVERFLOW=YES
DEF_EXPORTS="${DEF_NAME}-cli ${DEF_NAME}-server ${DEF_NAME}-benchmark ${DEF_NAME}-check-dump ${DEF_NAME}-check-aof ${DEF_NAME}-server ${DEF_NAME}-sentinel"
if [ "${SYSTEM_NAME}" = "Darwin" ]; then
    # under Darwin "leaks" is used .... so this crap is calling sudo N times one by one,
    # causing flood of "ask for root password" prompts... I have no further comments...
    DEF_TEST_METHOD="false"
fi
DEF_STANDALONE=YES
